<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>学成在线 | Jiang's blog</title><meta name="author" content="Jiang"><meta name="copyright" content="Jiang"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="学成在线项目">
<meta property="og:type" content="article">
<meta property="og:title" content="学成在线">
<meta property="og:url" content="https://love-you-3000.github.io/2023/06/22/xc_project/index.html">
<meta property="og:site_name" content="Jiang&#39;s blog">
<meta property="og:description" content="学成在线项目">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://love-you-3000.github.io/img/xc_cover.png">
<meta property="article:published_time" content="2023-06-22T06:10:20.000Z">
<meta property="article:modified_time" content="2023-06-23T08:54:23.705Z">
<meta property="article:author" content="Jiang">
<meta property="article:tag" content="JAVA">
<meta property="article:tag" content="项目">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://love-you-3000.github.io/img/xc_cover.png"><link rel="shortcut icon" href="/img/hacker.png"><link rel="canonical" href="https://love-you-3000.github.io/2023/06/22/xc_project/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: true
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '学成在线',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-06-23 16:54:23'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-double-row-display@1.00/cardlistpost.min.css"/>
<style>#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags:before {content:"\A";
  white-space: pre;}#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags > .article-meta__separator{display:none}</style>
<link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.css" /><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (false) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">2</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">2</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">1</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/xc_cover.png')"><nav id="nav"><span id="blog-info"><a href="/" title="Jiang's blog"><img class="site-icon" src="/img/logo.png"/><span class="site-name">Jiang's blog</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">学成在线</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-06-22T06:10:20.000Z" title="发表于 2023-06-22 14:10:20">2023-06-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-06-23T08:54:23.705Z" title="更新于 2023-06-23 16:54:23">2023-06-23</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/JAVA%E9%A1%B9%E7%9B%AE/">JAVA项目</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="学成在线"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="跨域请求"><a href="#跨域请求" class="headerlink" title="跨域请求"></a>跨域请求</h2><h3 id="什么是跨域请求"><a href="#什么是跨域请求" class="headerlink" title="什么是跨域请求"></a>什么是跨域请求</h3><p>CORS跨域资源共享。浏览器基于同源策略去判断是否发生了跨域请求，同源策略是浏览器的一种安全机制，从一个地址请求另一个地址，如果<strong>协议、主机、端口</strong>三者全部一致则不属于跨域，否则有一个不一致就是跨域请求。</p>
<p>比如：</p>
<p>从<a target="_blank" rel="noopener" href="http://localhost:8601/">http://localhost:8601</a> 到  <a target="_blank" rel="noopener" href="http://localhost:8602/">http://localhost:8602</a> 由于端口不同，是跨域。</p>
<p>从<a target="_blank" rel="noopener" href="http://192.168.101.10:8601/">http://192.168.101.10:8601</a> 到  <a target="_blank" rel="noopener" href="http://192.168.101.11:8601/">http://192.168.101.11:8601</a> 由于主机不同，是跨域。</p>
<p>从<a target="_blank" rel="noopener" href="http://192.168.101.10:8601/">http://192.168.101.10:8601</a> 到  <a target="_blank" rel="noopener" href="https://192.168.101.11:8601/">https://192.168.101.10:8601</a> 由于协议不同，是跨域。</p>
<p>注意：<strong>服务器之间不存在跨域请求。</strong></p>
<h3 id="解决跨域请求方案"><a href="#解决跨域请求方案" class="headerlink" title="解决跨域请求方案"></a>解决跨域请求方案</h3><ul>
<li><p>JSONP</p>
<p>通过script标签的src属性进行跨域请求，如果服务端要响应内容则首先读取请求参数callback的值，callback是一个回调函数的名称，服务端读取callback的值后将响应内容通过调用callback函数的方式告诉请求方。</p>
</li>
<li><p>添加响应头</p>
<p>服务端在响应头添加<code> Access-Control-Allow-Origin：*</code></p>
<p>*代表代替成要放行的请求，如果直接写*代表放行一切请求。</p>
</li>
<li><p>nginx代理跨域</p>
<p>由于服务端之间没有跨域，浏览器通过nginx去访问跨域地址。</p>
<p><img src="https://raw.githubusercontent.com/love-you-3000/picUpload/master/images/image-20230604100059221.png" alt="image-20230604100059221"></p>
</li>
</ul>
<h2 id="统一异常处理"><a href="#统一异常处理" class="headerlink" title="统一异常处理"></a>统一异常处理</h2><p>使用枚举类定义不同的异常返回信息，然后自定义业务异常，让其继承RunTimeException，最后使用<code>*@ControllerAdvice*</code>注解配置统一异常管理类。</p>
<p>因为要统一返回前端数据的格式，因此捕获异常后要自定义一个返回类返回异常信息给前端。</p>
<h2 id="JSR-303校验"><a href="#JSR-303校验" class="headerlink" title="JSR-303校验"></a>JSR-303校验</h2><p>JSR是Java Specification Requests的缩写，意思是Java 规范提案</p>
<p>JSR-303 是JAVA EE 6 中的一项子规范，叫做Bean Validation</p>
<p>即，JSR 303，Bean Validation规范 ，为Bean验证定义了元数据模型和API.。默认的元数据模型是通过Annotations来描述的，但是也可以使用XML来重载或者扩展。</p>
<p>分类：Bean Validation 中内置的 constraint</p>
<p>| Constraint                  | 详细信息                                                 |<br>|  | – |<br>| @Null                       | 被注释的元素必须为 null                                  |<br>| <strong>@NotNull</strong>                | 被注释的元素必须不为 null                                |<br>| @AssertTrue                 | 被注释的元素必须为 true                                  |<br>| @AssertFalse                | 被注释的元素必须为 false                                 |<br>| @Min(value)                 | 被注释的元素必须是一个数字，其值必须大于等于指定的最小值 |<br>| @Max(value)                 | 被注释的元素必须是一个数字，其值必须小于等于指定的最大值 |<br>| @DecimalMin(value)          | 被注释的元素必须是一个数字，其值必须大于等于指定的最小值 |<br>| @DecimalMax(value)          | 被注释的元素必须是一个数字，其值必须小于等于指定的最大值 |<br>| @Size(max, min)             | 被注释的元素的大小必须在指定的范围内                     |<br>| @Digits (integer, fraction) | 被注释的元素必须是一个数字，其值必须在可接受的范围内     |<br>| @Past                       | 被注释的元素必须是一个过去的日期                         |<br>| @Futuret                    | 被注释的元素必须是一个将来的日期                         |<br>| <strong>@Pattern(value)</strong>         | 被注释的元素必须符合指定的正则表达式                     |</p>
<p>分类：Hibernate Validator 附加的 constraint</p>
<table>
<thead>
<tr>
<th>Constraint</th>
<th>详细信息</th>
</tr>
</thead>
<tbody><tr>
<td>@Email</td>
<td>被注释的元素必须是电子邮箱地址</td>
</tr>
<tr>
<td>@Length</td>
<td>被注释的字符串的大小必须在指定的范围内</td>
</tr>
<tr>
<td>@NotEmpty</td>
<td>被注释的字符串的必须非空</td>
</tr>
<tr>
<td>@Range</td>
<td>被注释的元素必须在合适的范围内</td>
</tr>
</tbody></table>
<h3 id="使用步骤"><a href="#使用步骤" class="headerlink" title="使用步骤"></a>使用步骤</h3><ul>
<li><p>导入pom</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-validation&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>按照需求进行自定义校验规则</p>
</li>
<li><p>controller中加入<code>@Validated</code>注解</p>
</li>
</ul>
<h2 id="分组校验"><a href="#分组校验" class="headerlink" title="分组校验"></a>分组校验</h2><p>相同的字段属性在不同的情况下，校验的规则有所区别。</p>
<p>例如，一个实体类的的 id 在新增的情况下，需要校验是否为空，而在修改的情况下则不需要。同理，实体类的其他属性字段在新增和修改的情况下也有所差异</p>
<h3 id="分组校验步骤"><a href="#分组校验步骤" class="headerlink" title="分组校验步骤"></a>分组校验步骤</h3><p>① ：新增校验的分组接口（空接口，不需要实现）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ValidationGroups</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Insert</span>&#123;&#125;;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Update</span>&#123;&#125;;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Delete</span>&#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>② ：在实体类的属性字段上新增分组属性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NotEmpty(message = &quot;新增课程名称不能为空&quot;, groups = &#123;ValidationGroups.Insert.class&#125;)</span></span><br><span class="line"> <span class="meta">@NotEmpty(message = &quot; 修改课程名称不能为空&quot;, groups = &#123;ValidationGroups.Update.class&#125;)</span></span><br><span class="line"> <span class="meta">@ApiModelProperty(value = &quot;课程名称&quot;, required = true)</span></span><br><span class="line"> <span class="keyword">private</span> String name;</span><br></pre></td></tr></table></figure>

<p>③：在Controller 层的方法上新增 @Validated({xxx.class}) 分组属性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;新增课程基础信息&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/course&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">createCourseBase</span><span class="params">(<span class="meta">@RequestBody</span> <span class="meta">@Validated(ValidationGroups.Insert.class)</span> AddCourseDto addCourseDto)</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">companyId</span> <span class="operator">=</span> <span class="number">1232141425L</span>;</span><br><span class="line">    <span class="keyword">return</span> courseBaseService.createCourseBase(companyId, addCourseDto);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Nacos服务注册发现"><a href="#Nacos服务注册发现" class="headerlink" title="Nacos服务注册发现"></a>Nacos服务注册发现</h2><h3 id="导入相关pom包"><a href="#导入相关pom包" class="headerlink" title="导入相关pom包"></a>导入相关pom包</h3><p>在父工程下导入依赖</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-alibaba-dependencies&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;$&#123;spring-cloud-alibaba.version&#125;&lt;/version&gt;</span><br><span class="line">    &lt;type&gt;pom&lt;/type&gt;</span><br><span class="line">    &lt;scope&gt;<span class="keyword">import</span>&lt;/scope&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>在需要发现的服务下导入依赖</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h3 id="配置nacos地址"><a href="#配置nacos地址" class="headerlink" title="配置nacos地址"></a>配置nacos地址</h3><p>在需要发现的服务下的配置文件中写入：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">system-service</span> <span class="comment"># 服务名称</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.101</span><span class="number">.65</span><span class="string">:8848</span> <span class="comment">## nacos地址</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span> <span class="comment">## 命名空间</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-project</span> <span class="comment">## 组名</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>命名空间区分什么环境，比如生产环境，发布环境。</p>
<p>组可以理解为是一个命名环境下的不同项目。</p>
<p>重启服务便可以注册到nacos。</p>
<h2 id="Nacos统一配置管理"><a href="#Nacos统一配置管理" class="headerlink" title="Nacos统一配置管理"></a>Nacos统一配置管理</h2><p>对于某一个微服务，配置文件可以放到nacos中进行统一管理。具体步骤如下：</p>
<h3 id="导入pom包"><a href="#导入pom包" class="headerlink" title="导入pom包"></a>导入pom包</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--nacos配置管理依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="添加bootstrap-yaml"><a href="#添加bootstrap-yaml" class="headerlink" title="添加bootstrap.yaml"></a>添加bootstrap.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">content</span> <span class="comment"># 服务名</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span> <span class="comment"># 环境名</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-project</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-project</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span> <span class="comment"># 后缀名</span></span><br><span class="line">        <span class="attr">refresh-enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>nacos会读取nacos端对应组下面格式为<code>$&#123;spring.application.name&#125;-$&#123;spring.profiles.active&#125;.$&#123;spring.cloud.nacos.config.file-extension&#125;</code></p>
<p>作为文件id，来读取配置。</p>
<p>本项目中，content对应的配置为content-dev.yaml.</p>
<h3 id="nacos生成配置文件"><a href="#nacos生成配置文件" class="headerlink" title="nacos生成配置文件"></a>nacos生成配置文件</h3><p>在对应的命名空间下创建配置文件，名称符合上述规则。</p>
<h2 id="网关gateway"><a href="#网关gateway" class="headerlink" title="网关gateway"></a>网关gateway</h2><p>加入网关对微服务进行统一路由</p>
<h3 id="新建网关模块，导入pom"><a href="#新建网关模块，导入pom" class="headerlink" title="新建网关模块，导入pom"></a>新建网关模块，导入pom</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">XML</span><br><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuecheng<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-plus-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">relativePath</span>&gt;</span>../xuecheng-plus-parent<span class="tag">&lt;/<span class="name">relativePath</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-plus-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--网关--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--服务发现中心--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 排除 Spring Boot 依赖的日志包冲突 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Spring Boot 集成 log4j2 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-log4j2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="配置网关的bootstrap-yaml配置文件"><a href="#配置网关的bootstrap-yaml配置文件" class="headerlink" title="配置网关的bootstrap.yaml配置文件"></a>配置网关的bootstrap.yaml配置文件</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">配置网关的bootstrap.yaml配置文件</span></span><br><span class="line"><span class="string">YAML</span></span><br><span class="line"><span class="comment">#微服务配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-project</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-project</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">        <span class="attr">refresh-enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">shared-configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">logging-$&#123;spring.profiles.active&#125;.yaml</span></span><br><span class="line">            <span class="attr">group:</span> <span class="string">xuecheng-common</span></span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="nacos配置gateway配置文件"><a href="#nacos配置gateway配置文件" class="headerlink" title="nacos配置gateway配置文件"></a>nacos配置gateway配置文件</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">63010</span> <span class="comment"># 网关端口</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line"><span class="comment">#      filter:</span></span><br><span class="line"><span class="comment">#        strip-prefix:</span></span><br><span class="line"><span class="comment">#          enabled: true</span></span><br><span class="line">      <span class="attr">routes:</span> <span class="comment"># 网关路由配置</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">content</span> <span class="comment"># 路由id，自定义，只要唯一即可</span></span><br><span class="line">          <span class="comment"># uri: http://127.0.0.1:8081 # 路由的目标地址 http就是固定地址</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://content</span> <span class="comment"># 路由的目标地址 lb就是负载均衡，后面跟服务名称</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment"># 路由断言，也就是判断请求是否符合路由规则的条件</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/content/**</span> <span class="comment"># 这个是按照路径匹配，只要以/content/开头就符合要求</span></span><br><span class="line"><span class="comment">#          filters:</span></span><br><span class="line"><span class="comment">#            - StripPrefix=1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">system</span></span><br><span class="line">          <span class="comment"># uri: http://127.0.0.1:8081</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://system</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/system/**</span></span><br><span class="line"><span class="comment">#          filters:</span></span><br><span class="line"><span class="comment">#            - StripPrefix=1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">media</span></span><br><span class="line">          <span class="comment"># uri: http://127.0.0.1:8081</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://media</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/media/**</span></span><br><span class="line"><span class="comment">#          filters:</span></span><br><span class="line"><span class="comment">#            - StripPrefix=1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">search</span></span><br><span class="line">          <span class="comment"># uri: http://127.0.0.1:8081</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://search</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/search/**</span></span><br><span class="line"><span class="comment">#          filters:</span></span><br><span class="line"><span class="comment">#            - StripPrefix=1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">auth</span></span><br><span class="line">          <span class="comment"># uri: http://127.0.0.1:8081</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://auth</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/auth/**</span></span><br><span class="line"><span class="comment">#          filters:</span></span><br><span class="line"><span class="comment">#            - StripPrefix=1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">checkcode</span></span><br><span class="line">          <span class="comment"># uri: http://127.0.0.1:8081</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://checkcode</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/checkcode/**</span></span><br><span class="line"><span class="comment">#          filters:</span></span><br><span class="line"><span class="comment">#            - StripPrefix=1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">learning</span></span><br><span class="line">          <span class="comment"># uri: http://127.0.0.1:8081</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://learning</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/learning/**</span></span><br><span class="line"><span class="comment">#          filters:</span></span><br><span class="line"><span class="comment">#            - StripPrefix=1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">orders</span></span><br><span class="line">          <span class="comment"># uri: http://127.0.0.1:8081</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://orders</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/orders/**</span></span><br><span class="line"><span class="comment">#          filters:</span></span><br><span class="line"><span class="comment">#            - StripPrefix=1</span></span><br></pre></td></tr></table></figure>



<h2 id="上传文件【重点】"><a href="#上传文件【重点】" class="headerlink" title="上传文件【重点】"></a>上传文件【重点】</h2><h3 id="Minio云存储"><a href="#Minio云存储" class="headerlink" title="Minio云存储"></a>Minio云存储</h3><p>​	项目中的图片、pdf、视频等信息要全部存放在云存储中，本项目中将Minio部署到了docker中，用java操作minio首先需要导入相关依赖。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.minio<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>minio<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.4.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.squareup.okhttp3<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>okhttp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>需要服务地址以及minio的账号密码方可连接到服务端，这些信息写到配置文件中，然后在配置类中读取生成client类注入到spring容器中去。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MinioConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;minio.endpoint&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String endpoint;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;minio.accessKey&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String accessKey;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;minio.secretKey&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String secretKey;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MinioClient <span class="title function_">minioClient</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> MinioClient.builder()</span><br><span class="line">                .endpoint(endpoint)</span><br><span class="line">                .credentials(accessKey, secretKey)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>利用minio上传删除文件可以查看media模块下的测试类回顾，这里不做记录。</p>
<h3 id="上传图片"><a href="#上传图片" class="headerlink" title="上传图片"></a>上传图片</h3><p>这块知识点很多，需要好好消化，很多API都用的不熟练。</p>
<p>主要是要掌握上传文件的流程。</p>
<p>流程图如下：</p>
<p><img src="https://raw.githubusercontent.com/love-you-3000/picUpload/master/images/image-20230608171221775.png" alt="image-20230608171221775"></p>
<p>1、前端进入上传图片界面</p>
<p>2、上传图片，请求媒资管理服务。</p>
<p>3、媒资管理服务将图片文件存储在MinIO。</p>
<p>4、媒资管理记录文件信息到数据库。</p>
<p>5、前端请求内容管理服务保存课程信息，在内容管理数据库保存图片地址。</p>
<h4 id="接口类型"><a href="#接口类型" class="headerlink" title="接口类型"></a>接口类型</h4><p>首先第一个知识点，文件应该用什么类型来接收？在Spring中提供了<code>*MultipartFile*</code>来处理，接口定义为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(value = &quot;/upload/coursefile&quot;, consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span></span><br><span class="line">    <span class="keyword">public</span> UploadFileResultDto <span class="title function_">upload</span><span class="params">(<span class="meta">@RequestPart(&quot;filedata&quot;)</span> MultipartFile upload)</span> <span class="keyword">throws</span> IOException </span><br></pre></td></tr></table></figure>

<p>这里有很多疑问，首先，<code>@RequestPart(&quot;filedata&quot;)</code>中的<code>filedata</code>要和请求里的name字段匹配，不然接受不到文件，请求如下:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">### 上传文件</span><br><span class="line">POST &#123;&#123;gateway_host&#125;&#125;/media/upload/coursefile</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=WebAppBoundary</span><br><span class="line"></span><br><span class="line">--WebAppBoundary</span><br><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>form-data; name=&quot;filedata&quot;; filename=&quot;1.jpg&quot;</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt; d:/upload/1.jpg</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>至于为什么，我已经看了3个小时了，还是没弄懂，需要恶补HTTP协议的相关东西，先把整个流程记录完再说。</p>
<h4 id="文件处理"><a href="#文件处理" class="headerlink" title="文件处理"></a>文件处理</h4><p>接受到文件后，需要把这个文件上传到minio已经相关内容存储到数据库，这个项目的逻辑是，首先生成该文件的副本到本地，然后读取本地文件将其上传到服务器，最后处理完后删除本地副本。</p>
<p>生成副本的命令是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">File</span> <span class="variable">tempFile</span> <span class="operator">=</span> File.createTempFile(<span class="string">&quot;minio&quot;</span>, <span class="string">&quot;.temp&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>两个参数代表副本文件的前缀和后缀。</p>
<p>然后使用<code>transferTo</code>命令将接收到的文件保存到副本中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">upload.transferTo(tempFile);</span><br></pre></td></tr></table></figure>

<p>然后再service中实现上传和存储数据库的逻辑。</p>
<p>最后删除本地副本。</p>
<h4 id="上传文件"><a href="#上传文件" class="headerlink" title="上传文件"></a>上传文件</h4><p>这块的主要逻辑是先根据文件获得MD5码，因为文件id就是md5码，所以先根据这个判断文件是否已经上传过，如果没上传过，首先先上传到minio ，上传上去的文件路径是年月日三个文件夹加上文件名，这块可以封装一个方法获取路径，上传成功后，再把相关信息填到实体类中保存到数据库。</p>
<p>这里面的<strong>难点</strong>是，要理清楚逻辑顺序，上传minio的代码比较固定，依葫芦画瓢就行。</p>
<h4 id="事务优化"><a href="#事务优化" class="headerlink" title="事务优化"></a>事务优化</h4><p>之前的方法在整个service方法上加入了<code>*@Transactional*</code>方法，但是上传minio有网络带宽，整个做事务效率会很低，只要在写入数据库这部分加入事务，但是将这部分代码提取出来直接加上事务注解是没有用的，因为spring事务的执行者是接口的代理对象，比如定义了一个mapper接口，按照接口类型注入一个对象，这个对象就是这个接口的代理对象，只有代理对象才能是的事务起作用。</p>
<p><img src="https://raw.githubusercontent.com/love-you-3000/picUpload/master/images/image-20230608210911971.png" alt="image-20230608210911971">而原先的代码中，我们是实例化的service接口，也就是serviceImp，我们再该类的方法上加了事务注解，是没有用的，因此为了解决这个问题，我们可以在这个类中，把service接口住进来，让spring生成代理对象， 再调用代理对象来使用这个方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MediaFileServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">MediaFileService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MediaFileService selfProxy;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="comment">// 调用的时候</span></span><br><span class="line">selfProxy.addMediaFilesToDb(companyId, mediaFiles, fileMd5, uploadPath);</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addMediaFilesToDb</span><span class="params">(...)</span></span><br></pre></td></tr></table></figure>

<h2 id="【面试题】-什么时候spring事务会失效"><a href="#【面试题】-什么时候spring事务会失效" class="headerlink" title="【面试题】 什么时候spring事务会失效"></a>【面试题】 什么时候spring事务会失效</h2><h3 id="Spring事务"><a href="#Spring事务" class="headerlink" title="Spring事务"></a>Spring事务</h3><p>spring事务分别是<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E7%BC%96%E7%A8%8B%E5%BC%8F%E4%BA%8B%E5%8A%A1&spm=1001.2101.3001.7020">编程式事务</a>和声明式事务，后者最常见，通常情况下只需要一个 **@Transactional **就搞定了（代码侵入性降到了最低）</p>
<p>这里先只说声明式事务。这种方式的原理是利用了Spring的AOP机制，在方法执行前后进行了拦截，然后在目标方法开始之前创建或者加入一个事务，执行完目标方法之后根据执行的情况提交或者回滚。</p>
<p><strong>声明式事务虽然优于编程式事务，但也有不足，声明式事务管理的粒度是方法级别，而编程式事务是可以精确到代码块级别的。</strong></p>
<h3 id="事务传播行为"><a href="#事务传播行为" class="headerlink" title="事务传播行为"></a>事务传播行为</h3><p>当事务方法被另外一个事务方法调用时，必须指定事务应该如何传播，例如，方法可能继续在当前事务中执行，也可以开启一个新的事务，在自己的事务中执行。<br>声明式事务的传播行为可以通过 @Transactional 注解中的 propagation 属性来定义。</p>
<h3 id="什么时候事务会失效"><a href="#什么时候事务会失效" class="headerlink" title="什么时候事务会失效"></a>什么时候事务会失效</h3><ul>
<li>在方法中捕获异常没有抛出去。</li>
<li>非事务方法调用事务方法。原因还是因为不是代理对象调用。</li>
<li>事务方法内部调用事务方法。这样也会失效，还是得在内部显示调用代理对象的事务方法。</li>
<li>作用于非public方法上</li>
<li>数据库不支持事务</li>
</ul>
<h2 id="断点续传"><a href="#断点续传" class="headerlink" title="断点续传"></a>断点续传</h2><h3 id="断点续传流程"><a href="#断点续传流程" class="headerlink" title="断点续传流程"></a>断点续传流程</h3><ul>
<li>前端对文件进行分块；</li>
<li>前端使用多线程对文件进行分块上传，对于每一个分块，前端会对询问后端该分块是否已经上传，对于已经上传的分块不再上传；</li>
<li>等所有分块上传完毕，服务端合并所有分块，并校验文件的完整性；</li>
<li>合并完成后和前端传入的md5值比较检验文件完整性。</li>
<li>注意，在检测分块和上传文件前，都应该先判断该md5值对应的文件是否已存在，也就是对于重复上传整个文件，也应该直接返回。</li>
</ul>
<h2 id="视频转码处理"><a href="#视频转码处理" class="headerlink" title="视频转码处理"></a>视频转码处理</h2><hr>
<p>视频上传成功后，并不是所有的格式都支持浏览器播放，因此需要对用户上传的视频进行转码操作，转码主要通过ffmpeg工具，该工具通用强大的视频转码功能，我们的重点不在如何用java使用这个工具，因此这块直接使用提供好的工具类。</p>
<p>在用户上传了视频文件后，首先会将该文件上传到minio，同时，在数据库中会维护一张表记录哪些文件需要被转码，如果该文件是需要转码的文件，在上传后将该文件记录到待处理数据库中，然后使用定时任务去定时处理。</p>
<p>牛客社区中我们使用了Quartz调度，Quartz作为开源作业调度中的佼佼者，是作业调度的首选。但同样存在以下问题：</p>
<ul>
<li>问题一：调用API的的方式操作任务，不人性化；</li>
<li>问题二：需要持久化业务QuartzJobBean到底层数据表中，系统侵入性相当严重。</li>
<li>问题三：调度逻辑和QuartzJobBean耦合在同一个项目中，这将导致一个问题，在调度任务数量逐渐增多，同时调度任务逻辑逐渐加重的情况下，此时调度系统的性能将大大受限于业务；</li>
<li>问题四：quartz底层以“抢占式”获取DB锁并由抢占成功节点负责运行任务，会导致节点负载悬殊非常大；而XXL-JOB通过执行器实现“协同分配式”运行任务，充分发挥集群优势，负载各节点均衡。</li>
</ul>
<p>本项目中使用一款分布式任务调度平台XXL-JOB来实现定时任务。</p>
<h3 id="xxl-job"><a href="#xxl-job" class="headerlink" title="xxl-job"></a>xxl-job</h3><p>XXL-JOB是一个分布式任务调度平台，其核心设计目标是开发迅速、学习简单、轻量级、易扩展。现已开放源代码并接入多家公司线上产品线，开箱即用。</p>
<p>xxl-job拥有以下特点：</p>
<ul>
<li>1、简单：支持通过Web页面对任务进行CRUD操作，操作简单，一分钟上手；</li>
<li>2、动态：支持动态修改任务状态、启动&#x2F;停止任务，以及终止运行中任务，即时生效；</li>
<li>3、调度中心HA（中心式）：调度采用中心式设计，“调度中心”自研调度组件并支持集群部署，可保证调度中心HA；</li>
<li>4、执行器HA（分布式）：任务分布式执行，任务”执行器”支持集群部署，可保证任务执行HA；</li>
<li>5、注册中心: 执行器会周期性自动注册任务, 调度中心将会自动发现注册的任务并触发执行。同时，也支持手动录入执行器地址；</li>
<li>6、弹性扩容缩容：一旦有新执行器机器上线或者下线，下次调度时将会重新分配任务；</li>
<li>7、触发策略：提供丰富的任务触发策略，包括：Cron触发、固定间隔触发、固定延时触发、API（事件）触发、人工触发、父子任务触发；</li>
<li>8、调度过期策略：调度中心错过调度时间的补偿处理策略，包括：忽略、立即补偿触发一次等；</li>
<li>9、阻塞处理策略：调度过于密集执行器来不及处理时的处理策略，策略包括：单机串行（默认）、丢弃后续调度、覆盖之前调度；</li>
<li>10、任务超时控制：支持自定义任务超时时间，任务运行超时将会主动中断任务；</li>
<li>11、任务失败重试：支持自定义任务失败重试次数，当任务失败时将会按照预设的失败重试次数主动进行重试；其中分片任务支持分片粒度的失败重试；</li>
<li>12、任务失败告警；默认提供邮件方式失败告警，同时预留扩展接口，可方便的扩展短信、钉钉等告警方式；</li>
<li>13、路由策略：执行器集群部署时提供丰富的路由策略，包括：第一个、最后一个、轮询、随机、一致性HASH、最不经常使用、最近最久未使用、故障转移、忙碌转移等；</li>
<li>14、分片广播任务：执行器集群部署时，任务路由策略选择”分片广播”情况下，一次任务调度将会广播触发集群中所有执行器执行一次任务，可根据分片参数开发分片任务；</li>
<li>15、动态分片：分片广播任务以执行器为维度进行分片，支持动态扩容执行器集群从而动态增加分片数量，协同进行业务处理；在进行大数据量业务操作时可显著提升任务处理能力和速度。</li>
<li>16、故障转移：任务路由策略选择”故障转移”情况下，如果执行器集群中某一台机器故障，将会自动Failover切换到一台正常的执行器发送调度请求。</li>
<li>17、任务进度监控：支持实时监控任务进度；</li>
<li>18、Rolling实时日志：支持在线查看调度结果，并且支持以Rolling方式实时查看执行器输出的完整的执行日志；</li>
<li>19、GLUE：提供Web IDE，支持在线开发任务逻辑代码，动态发布，实时编译生效，省略部署上线的过程。支持30个版本的历史版本回溯。</li>
<li>20、脚本任务：支持以GLUE模式开发和运行脚本任务，包括Shell、Python、NodeJS、PHP、PowerShell等类型脚本;</li>
<li>21、命令行任务：原生提供通用命令行任务Handler（Bean任务，”CommandJobHandler”）；业务方只需要提供命令行即可；</li>
<li>22、任务依赖：支持配置子任务依赖，当父任务执行结束且执行成功后将会主动触发一次子任务的执行, 多个子任务用逗号分隔；</li>
<li>23、一致性：“调度中心”通过DB锁保证集群分布式调度的一致性, 一次任务调度只会触发一次执行；</li>
<li>24、自定义任务参数：支持在线配置调度任务入参，即时生效；</li>
<li>25、调度线程池：调度系统多线程触发调度运行，确保调度精确执行，不被堵塞；</li>
<li>26、数据加密：调度中心和执行器之间的通讯进行数据加密，提升调度信息安全性；</li>
<li>27、邮件报警：任务失败时支持邮件报警，支持配置多邮件地址群发报警邮件；</li>
<li>28、推送maven中央仓库: 将会把最新稳定版推送到maven中央仓库, 方便用户接入和使用;</li>
<li>29、运行报表：支持实时查看运行数据，如任务数量、调度次数、执行器数量等；以及调度报表，如调度日期分布图，调度成功分布图等；</li>
<li>30、全异步：任务调度流程全异步化设计实现，如异步调度、异步运行、异步回调等，有效对密集调度进行流量削峰，理论上支持任意时长任务的运行；</li>
<li>31、跨语言：调度中心与执行器提供语言无关的 RESTful API 服务，第三方任意语言可据此对接调度中心或者实现执行器。除此之外，还提供了 “多任务模式”和“httpJobHandler”等其他跨语言方案；</li>
<li>32、国际化：调度中心支持国际化设置，提供中文、英文两种可选语言，默认为中文；</li>
<li>33、容器化：提供官方docker镜像，并实时更新推送dockerhub，进一步实现产品开箱即用；</li>
<li>34、线程池隔离：调度线程池进行隔离拆分，慢任务自动降级进入”Slow”线程池，避免耗尽调度线程，提高系统稳定性；</li>
<li>35、用户管理：支持在线管理系统用户，存在管理员、普通用户两种角色；</li>
<li>36、权限控制：执行器维度进行权限控制，管理员拥有全量权限，普通用户需要分配执行器权限后才允许相关操作；</li>
</ul>
<p>XXL-JOB是基于调度中心和执行器、任务等概念的定时任务组件</p>
<p><img src="https://raw.githubusercontent.com/love-you-3000/picUpload/master/images/image-20230612143055180.png" alt="image-20230612143055180"></p>
<p><strong>调度中心：</strong></p>
<p>​    负责管理调度信息，按照调度配置发出调度请求，<strong>自身不承担业务代码</strong>；</p>
<p>​    主要职责为执行器管理、任务管理、监控运维、日志管理等</p>
<p><strong>任务执行器：</strong></p>
<p>​    负责接收调度请求并执行任务逻辑；</p>
<p>​    主要职责是注册服务、任务执行服务（接收到任务后会放入线程池中的任务队列）、执行结果上报、日志服务等</p>
<p><strong>任务：</strong>负责执行具体的业务处理。</p>
<p>调度中心与执行器之间的工作流程如下：</p>
<p><img src="https://raw.githubusercontent.com/love-you-3000/picUpload/master/images/image-20230612143150479.png" alt="image-20230612143150479"></p>
<p><strong>执行流程：</strong></p>
<p>​    1.任务执行器根据配置的调度中心的地址，自动注册到调度中心</p>
<p>​    2.达到任务触发条件，调度中心下发任务</p>
<p>​    3.执行器基于线程池执行任务，并把执行结果放入内存队列中、把执行日志写入日志文件中</p>
<p>​    4.执行器消费内存队列中的执行结果，主动上报给调度中心</p>
<p>​    5.当用户在调度中心查看任务日志，调度中心请求任务执行器，任务执行器读取任务日志文件并返回日志详情</p>
<h3 id="搭建xxl-job"><a href="#搭建xxl-job" class="headerlink" title="搭建xxl-job"></a>搭建xxl-job</h3><h4 id="搭建调度中心"><a href="#搭建调度中心" class="headerlink" title="搭建调度中心"></a>搭建调度中心</h4><p>首先下载XXL-JOB</p>
<p>GitHub：<a target="_blank" rel="noopener" href="https://github.com/xuxueli/xxl-job">https://github.com/xuxueli/xxl-job</a></p>
<p>下载后主要包含这些信息：</p>
<p>xxl-job-admin：调度中心</p>
<p>xxl-job-core：公共依赖</p>
<p>xxl-job-executor-samples：执行器Sample示例（选择合适的版本执行器，可直接使用）</p>
<p>  ：xxl-job-executor-sample-springboot：Springboot版本，通过Springboot管理执行器，推荐这种方式；</p>
<p>  ：xxl-job-executor-sample-frameless：无框架版本；</p>
<p>doc :文档资料，包含数据库脚本</p>
<p>首先需要使用数据库脚本生成对应的数据库；</p>
<p>然后启动xxl-job-admin，可以直接idea启动，或者打包成jar启动，或者通过docker镜像启动。</p>
<p>此时调度中心已经搭建完毕，在浏览器中可以访问。</p>
<h4 id="创建执行器"><a href="#创建执行器" class="headerlink" title="创建执行器"></a>创建执行器</h4><p>在浏览器中右边点击执行器管理然后新增执行器，appname是前边在nacos中配置xxl信息时指定的执行器的应用名。</p>
<p><img src="https://raw.githubusercontent.com/love-you-3000/picUpload/master/images/image-20230612143623474.png" alt="image-20230612143623474"></p>
<p><img src="https://raw.githubusercontent.com/love-you-3000/picUpload/master/images/image-20230612143658342.png" alt="image-20230612143658342"></p>
<p>新增执行器后在对应的微服务中添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuxueli<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xxl-job-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在nacos下的media-service-dev.yaml下配置xxl-job</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">xxl:</span></span><br><span class="line">  <span class="attr">job:</span></span><br><span class="line">    <span class="attr">admin:</span> </span><br><span class="line">      <span class="attr">addresses:</span> <span class="string">http://localhost:8080/xxl-job-admin</span></span><br><span class="line">    <span class="attr">executor:</span></span><br><span class="line">      <span class="attr">appname:</span> <span class="string">media-executor</span></span><br><span class="line">      <span class="attr">address:</span> </span><br><span class="line">      <span class="attr">ip:</span> </span><br><span class="line">      <span class="attr">port:</span> <span class="number">9999</span></span><br><span class="line">      <span class="attr">logpath:</span> <span class="string">/data/applogs/xxl-job/jobhandler</span></span><br><span class="line">      <span class="attr">logretentiondays:</span> <span class="number">30</span></span><br><span class="line">    <span class="attr">accessToken:</span> <span class="string">default_token</span></span><br></pre></td></tr></table></figure>

<p><strong>将xxl-job示例程序中的配置文件拷贝到对应微服务的config下。</strong></p>
<p>重启观察日志，正常情况执行器就注册成功了。</p>
<h4 id="执行任务"><a href="#执行任务" class="headerlink" title="执行任务"></a>执行任务</h4><p>在service包下新建包jobhandler，新建类VideoJobHandler，该类需要加上<code>@Component</code>注解，在需要执行的方法前加上<code> @XxlJob(&quot;videoJobHandler&quot;)</code>，方法体中加入具体的任务逻辑，然后在浏览器中新增任务：</p>
<p><img src="https://raw.githubusercontent.com/love-you-3000/picUpload/master/images/image-20230612144407164.png" alt="image-20230612144407164"></p>
<p>注意几个点：</p>
<ul>
<li><p>执行器要选择对应微服务注册的执行器；</p>
</li>
<li><p>CRON可以灵活指定定时任务的执行时间；</p>
</li>
<li><p>运行模式是<code>BEAN</code>，JobHandler中的名字要和方法体上面注解中填写的一致；</p>
</li>
<li><p>分片广播策略可以对任务进行分布式处理</p>
<p><img src="https://raw.githubusercontent.com/love-you-3000/picUpload/master/images/image-20230612144540916.png" alt="image-20230612144540916"></p>
</li>
</ul>
<p>​	其他高级配置：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">高级配置：</span><br><span class="line">    <span class="operator">-</span> 路由策略：当执行器集群部署时，提供丰富的路由策略，包括；</span><br><span class="line">        <span class="keyword">FIRST</span>（第一个）：固定选择第一个机器；</span><br><span class="line">        <span class="keyword">LAST</span>（最后一个）：固定选择最后一个机器；</span><br><span class="line">        ROUND（轮询）：；</span><br><span class="line">        RANDOM（随机）：随机选择在线的机器；</span><br><span class="line">        CONSISTENT_HASH（一致性HASH）：每个任务按照Hash算法固定选择某一台机器，且所有任务均匀散列在不同机器上。</span><br><span class="line">        LEAST_FREQUENTLY_USED（最不经常使用）：使用频率最低的机器优先被选举；</span><br><span class="line">        LEAST_RECENTLY_USED（最近最久未使用）：最久未使用的机器优先被选举；</span><br><span class="line">        FAILOVER（故障转移）：按照顺序依次进行心跳检测，第一个心跳检测成功的机器选定为目标执行器并发起调度；</span><br><span class="line">        BUSYOVER（忙碌转移）：按照顺序依次进行空闲检测，第一个空闲检测成功的机器选定为目标执行器并发起调度；</span><br><span class="line">        SHARDING_BROADCAST(分片广播)：广播触发对应集群中所有机器执行一次任务，同时系统自动传递分片参数；可根据分片参数开发分片任务；</span><br><span class="line"></span><br><span class="line">    <span class="operator">-</span> 子任务：每个任务都拥有一个唯一的任务ID(任务ID可以从任务列表获取)，当本任务执行结束并且执行成功时，将会触发子任务ID所对应的任务的一次主动调度，通过子任务可以实现一个任务执行完成去执行另一个任务。</span><br><span class="line">    <span class="operator">-</span> 调度过期策略：</span><br><span class="line">        <span class="operator">-</span> 忽略：调度过期后，忽略过期的任务，从当前时间开始重新计算下次触发时间；</span><br><span class="line">        <span class="operator">-</span> 立即执行一次：调度过期后，立即执行一次，并从当前时间开始重新计算下次触发时间；</span><br><span class="line">    <span class="operator">-</span> 阻塞处理策略：调度过于密集执行器来不及处理时的处理策略；</span><br><span class="line">        单机串行（默认）：调度请求进入单机执行器后，调度请求进入FIFO队列并以串行方式运行；</span><br><span class="line">        丢弃后续调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，本次请求将会被丢弃并标记为失败；</span><br><span class="line">        覆盖之前调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，将会终止运行中的调度任务并清空队列，然后运行本地调度任务；</span><br><span class="line">    <span class="operator">-</span> 任务超时时间：支持自定义任务超时时间，任务运行超时将会主动中断任务；</span><br><span class="line">    <span class="operator">-</span> 失败重试次数；支持自定义任务失败重试次数，当任务失败时将会按照预设的失败重试次数主动进行重试；</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="技术方案"><a href="#技术方案" class="headerlink" title="技术方案"></a>技术方案</h3><p>分片广播方式可以高效处理任务，但不能让不同的分片去处理同样的任务，因此实战中，每个执行从数据表取任务时可以让任务id 模上 分片总数，如果等于分片序号则执行此任务，这样可以保证执行器之间查询到不重复的任务。</p>
<p>同时我们还需要保证同一个任务不会被多次执行，在调度过期策略和阻塞处理策略中，我们分别选择忽略和丢弃后续调度来保证任务的不重复执行。</p>
<p>到此还不能完全保证任务不重复执行，还要保证任务的<strong>幂等性</strong>。</p>
<p>它描述了一次和多次请求某一个资源对于资源本身应该具有同样的结果。</p>
<p>幂等性是为了解决重复提交问题，比如：恶意刷单，重复支付等。</p>
<h3 id="视频处理方案"><a href="#视频处理方案" class="headerlink" title="视频处理方案"></a>视频处理方案</h3><p><img src="https://raw.githubusercontent.com/love-you-3000/picUpload/master/images/image-20230612150105450.png" alt="image-20230612150105450"></p>
<p><img src="https://raw.githubusercontent.com/love-you-3000/picUpload/master/images/image-20230612150118434.png" alt="image-20230612150118434"></p>
<p>1、任务调度中心广播作业分片。</p>
<p>2、执行器收到广播作业分片，从数据库读取待处理任务，读取未处理及处理失败的任务。</p>
<p>3、执行器更新任务为处理中，根据任务内容从MinIO下载要处理的文件。</p>
<p>4、执行器启动多线程去处理任务。</p>
<p>5、任务处理完成，上传处理后的视频到MinIO。</p>
<p>6、将更新任务处理结果，如果视频处理完成除了更新任务处理结果以外还要将文件的访问地址更新至任务处理表及文件表中，最后将任务完成记录写入历史表。</p>
<h3 id="10-5-分布式锁"><a href="#10-5-分布式锁" class="headerlink" title="10.5 分布式锁"></a>10.5 分布式锁</h3><p>为了避免某些节点失去通信，调度中心动态扩容导致重复执行任务，加入分布式锁来保证不会重复执行，方案有很多：</p>
<ul>
<li><p>基于数据库实现分布锁</p>
<p>利用数据库主键唯一性的特点，或利用数据库唯一索引、行级锁的特点，多个线程同时去更新相同的记录，谁更新成功谁就抢到锁。</p>
</li>
<li><p>基于redis实现锁</p>
<p>redis提供了分布式锁的实现方案，比如：SETNX、set nx、redisson等。拿SETNX举例说明，SETNX命令的工作过程是去set一个不存在的key，多个线程去设置同一个key只会有一个线程设置成功，设置成功的的线程拿到锁。</p>
</li>
<li><p>使用zookeeper实现</p>
<p>zookeeper是一个分布式协调服务，主要解决分布式程序之间的同步的问题。zookeeper的结构类似的文件目录，多线程向zookeeper创建一个子目录(节点)只会有一个创建成功，利用此特点可以实现分布式锁，谁创建该结点成功谁就获得锁。</p>
</li>
</ul>
<p>本项目使用数据库实现。</p>
<h3 id="10-6-视频处理"><a href="#10-6-视频处理" class="headerlink" title="10.6 视频处理"></a>10.6 视频处理</h3><p>这部分就是每个任务的具体逻辑，这部分使用多线程处理，每次处理的视频数量不要超过cpu核心数。所有视频处理完成结束本次执行，为防止代码异常出现无限期等待则添加超时设置，到达超时时间还没有处理完成仍结束任务。</p>
<p>核心代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VideoTaskJob</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MinioClient minioClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MediaProcessService mediaProcessService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MediaFileService mediaFileService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ffmpeg的路径</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;videoProcess.ffmpegPath&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String ffmpeg_path;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span>: 朱江</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span>: 视频处理任务逻辑</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span>: 9:29 2023/6/12</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="meta">@XxlJob(&quot;videoJobHandler&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">videoJobHandler</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 分片参数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">shardTotal</span> <span class="operator">=</span> XxlJobHelper.getShardTotal();</span><br><span class="line">        <span class="type">int</span> <span class="variable">shardIndex</span> <span class="operator">=</span> XxlJobHelper.getShardIndex();</span><br><span class="line">        <span class="comment">// 确定CPU核心数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">CpuCoreCount</span> <span class="operator">=</span> Runtime.getRuntime().availableProcessors();</span><br><span class="line">        <span class="comment">// 查询待处理的任务</span></span><br><span class="line">        List&lt;MediaProcess&gt; toProcess = mediaProcessService.selectByShardIndex(shardTotal, shardIndex, CpuCoreCount);</span><br><span class="line">        <span class="comment">// 待处理任务数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> toProcess.size();</span><br><span class="line">        log.info(<span class="string">&quot;分片id:&#123;&#125; 取到的视频任务数:&#123;&#125;&quot;</span>, shardIndex, size);</span><br><span class="line">        <span class="keyword">if</span> (size == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="comment">// 创建线程池</span></span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">threadPool</span> <span class="operator">=</span> Executors.newFixedThreadPool(size);</span><br><span class="line">        <span class="comment">// 使用计数器</span></span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(size);</span><br><span class="line">        toProcess.forEach(mediaProcess -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">md5</span> <span class="operator">=</span> mediaProcess.getFileId();</span><br><span class="line">            threadPool.execute(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 任务执行逻辑</span></span><br><span class="line">                    <span class="type">Long</span> <span class="variable">taskId</span> <span class="operator">=</span> mediaProcess.getId();</span><br><span class="line">                    <span class="keyword">if</span> (mediaProcessService.startTask(taskId)) &#123;</span><br><span class="line">                        <span class="comment">//源avi视频的路径</span></span><br><span class="line">                        <span class="type">String</span> <span class="variable">objectName</span> <span class="operator">=</span> mediaProcess.getFilePath();</span><br><span class="line">                        <span class="comment">// 从minio下载源文件</span></span><br><span class="line">                        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> mediaFileService.downloadFileFromMinIO(mediaProcess.getBucket(), objectName);</span><br><span class="line">                        <span class="keyword">if</span> (file == <span class="literal">null</span>) &#123;</span><br><span class="line">                            log.debug(<span class="string">&quot;下载视频出错, 任务id:&#123;&#125;, bucket:&#123;&#125;, objectName:&#123;&#125; &quot;</span>, taskId, mediaProcess.getBucket(), objectName);</span><br><span class="line">                            mediaProcessService.saveProcessFinishStatus(taskId, <span class="string">&quot;3&quot;</span>, md5, <span class="literal">null</span>, <span class="string">&quot;下载视频到本地失败！&quot;</span>);</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="type">File</span> <span class="variable">tempFile</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            tempFile = File.createTempFile(<span class="string">&quot;minio&quot;</span>, <span class="string">&quot;.mp4&quot;</span>);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                            log.debug(<span class="string">&quot;创建临时文件失败！&quot;</span>);</span><br><span class="line">                            mediaProcessService.saveProcessFinishStatus(taskId, <span class="string">&quot;3&quot;</span>, md5, <span class="literal">null</span>, <span class="string">&quot;创建临时文件失败！&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// ==============》执行文件转码《====================</span></span><br><span class="line">                        <span class="comment">//转换后mp4文件的路径</span></span><br><span class="line">                        <span class="type">String</span> <span class="variable">mp4_path</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                        <span class="keyword">if</span> (tempFile != <span class="literal">null</span>) &#123;</span><br><span class="line">                            mp4_path = tempFile.getAbsolutePath();</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//创建工具类对象</span></span><br><span class="line">                        <span class="type">Mp4VideoUtil</span> <span class="variable">videoUtil</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Mp4VideoUtil</span>(ffmpeg_path, file.getAbsolutePath(), mp4_path);</span><br><span class="line">                        <span class="comment">//开始视频转换，成功将返回success</span></span><br><span class="line">                        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> videoUtil.generateMp4();</span><br><span class="line">                        <span class="keyword">if</span> (!result.equals(<span class="string">&quot;success&quot;</span>)) &#123;</span><br><span class="line">                            log.debug(<span class="string">&quot;文件转码失败！&quot;</span>);</span><br><span class="line">                            mediaProcessService.saveProcessFinishStatus(taskId, <span class="string">&quot;3&quot;</span>, md5, <span class="literal">null</span>, <span class="string">&quot;文件转码失败！&quot;</span>);</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="type">String</span> <span class="variable">savePath</span> <span class="operator">=</span> md5.charAt(<span class="number">0</span>) + <span class="string">&quot;/&quot;</span> + md5.charAt(<span class="number">1</span>) + <span class="string">&quot;/&quot;</span> + md5 + <span class="string">&quot;/&quot;</span> + md5 + <span class="string">&quot;.mp4&quot;</span>;</span><br><span class="line">                        <span class="type">boolean</span> <span class="variable">uploadRes</span> <span class="operator">=</span> mediaFileService.uploadFileToMinio(mediaProcess.getBucket(), <span class="string">&quot;mp4&quot;</span>, savePath, mp4_path);</span><br><span class="line">                        <span class="keyword">if</span> (!uploadRes) &#123;</span><br><span class="line">                            log.debug(<span class="string">&quot;上传转码后文件失败！, taskId:&#123;&#125;&quot;</span>, taskId);</span><br><span class="line">                            mediaProcessService.saveProcessFinishStatus(taskId, <span class="string">&quot;3&quot;</span>, md5, <span class="literal">null</span>, <span class="string">&quot;上传转码后文件失败！&quot;</span>);</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        mediaProcessService.saveProcessFinishStatus(taskId, <span class="string">&quot;2&quot;</span>, md5, savePath, <span class="literal">null</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        log.debug(<span class="string">&quot;抢占任务失败, 任务id:&#123;&#125;&quot;</span>, taskId);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    countDownLatch.countDown();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">        countDownLatch.await(<span class="number">30</span>, TimeUnit.MINUTES);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="【面试题】如何实现幂等性"><a href="#【面试题】如何实现幂等性" class="headerlink" title="【面试题】如何实现幂等性"></a>【面试题】如何实现幂等性</h2><h3 id="方案一：数据库唯一主键"><a href="#方案一：数据库唯一主键" class="headerlink" title="方案一：数据库唯一主键"></a>方案一：数据库唯一主键</h3><p><strong>方案描述</strong></p>
<p>数据库唯一主键的实现主要是利用数据库中主键唯一约束的特性，一般来说唯一主键比较适用于“插入”时的幂等性，其能保证一张表中只能存在一条带该唯一主键的记录。</p>
<p><strong>适用操作：</strong></p>
<ul>
<li>插入操作</li>
<li>删除操作</li>
</ul>
<p><strong>使用限制：</strong></p>
<ul>
<li>需要生成全局唯一主键 ID；</li>
</ul>
<p>主要流程：</p>
<ul>
<li>① 客户端执行创建请求，调用服务端接口。</li>
<li>② 服务端执行业务逻辑，生成一个分布式 ID，将该 ID 充当待插入数据的主键，然后执数据插入操作，运行对应的 SQL 语句。</li>
<li>③ 服务端将该条数据插入数据库中，如果插入成功则表示没有重复调用接口。如果抛出主键重复异常，则表示数据库中已经存在该条记录，返回错误信息到客户端。</li>
</ul>
<h3 id="方案二：数据库乐观锁"><a href="#方案二：数据库乐观锁" class="headerlink" title="方案二：数据库乐观锁"></a>方案二：数据库<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E4%B9%90%E8%A7%82%E9%94%81&spm=1001.2101.3001.7020">乐观锁</a></h3><p><strong>方案描述：</strong></p>
<p>数据库乐观锁方案一般只能适用于执行“更新操作”的过程，我们可以提前在对应的数据表中多添加一个字段，充当当前数据的版本标识。这样每次对该数据库该表的这条数据执行更新时，都会将该版本标识作为一个条件，值为上次待更新数据中的版本标识的值。</p>
<p><strong>适用操作：</strong></p>
<ul>
<li>更新操作</li>
</ul>
<p><strong>使用限制：</strong></p>
<ul>
<li>需要数据库对应业务表中添加额外字段；</li>
</ul>
<h3 id="方案三：防重-Token-令牌"><a href="#方案三：防重-Token-令牌" class="headerlink" title="方案三：防重 Token 令牌"></a>方案三：防重 Token 令牌</h3><p><strong>方案描述：</strong></p>
<p>针对客户端连续点击或者调用方的超时重试等情况，例如提交订单，此种操作就可以用 Token 的机制实现防止重复提交。简单的说就是调用方在调用接口的时候先向后端请求一个全局 ID（Token），请求的时候携带这个全局 ID 一起请求（Token 最好将其放到 Headers 中），后端需要对这个 Token 作为 Key，用户信息作为 Value 到 Redis 中进行键值内容校验，如果 Key 存在且 Value 匹配就执行删除命令，然后正常执行后面的业务逻辑。如果不存在对应的 Key 或 Value 不匹配就返回重复执行的错误信息，这样来保证幂等操作。</p>
<p><strong>适用操作：</strong></p>
<ul>
<li>插入操作</li>
<li>更新操作</li>
<li>删除操作</li>
</ul>
<p><strong>使用限制：</strong></p>
<ul>
<li>需要生成全局唯一 Token 串；</li>
<li>需要使用第三方组件 Redis 进行数据效验；</li>
</ul>
<p><img src="https://raw.githubusercontent.com/love-you-3000/picUpload/master/images/watermark%252Ctype_ZmFuZ3poZW5naGVpdGk%252Cshadow_10%252Ctext_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxMTY5%252Csize_16%252Ccolor_FFFFFF%252Ct_70" alt="img"></p>
<ul>
<li>① 服务端提供获取 Token 的接口，该 Token 可以是一个序列号，也可以是一个分布式 ID 或者 UUID 串。</li>
<li>② 客户端调用接口获取 Token，这时候服务端会生成一个 Token 串。</li>
<li>③ 然后将该串存入 Redis 数据库中，以该 Token 作为 Redis 的键（注意设置过期时间）。</li>
<li>④ 将 Token 返回到客户端，客户端拿到后应存到表单隐藏域中。</li>
<li>⑤ 客户端在执行提交表单时，把 Token 存入到 Headers 中，执行业务请求带上该 Headers。</li>
<li>⑥ 服务端接收到请求后从 Headers 中拿到 Token，然后根据 Token 到 Redis 中查找该 key 是否存在。</li>
<li>⑦ 服务端根据 Redis 中是否存该 key 进行判断，如果存在就将该 key 删除，然后正常执行业务逻辑。如果不存在就抛异常，返回重复提交的错误信息。</li>
</ul>
<blockquote>
<p>注意，在并发情况下，执行 Redis 查找数据与删除需要保证原子性，否则很可能在并发下无法保证幂等性。其实现方法可以使用分布式锁或者使用 Lua 表达式来注销查询与删除操作。</p>
</blockquote>
<p>本项目中，我们在表中引入status字段来判断任务是否已完成，如果已完成就不再处理，来保证幂等性。</p>
<h2 id="Feign远程调用"><a href="#Feign远程调用" class="headerlink" title="Feign远程调用"></a>Feign远程调用</h2><p>每一个微服务都有自己的数据库等信息，其他微服务不能会直接访问另一个微服务的数据信息，如果有此类需求，需要使用Feign远程调用来调用其他微服务的方法。</p>
<p>首先引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在项目中我们需要使用内容管理服务调用媒资管理服务的上传文件到minio接口， 这里请求的参数是文件类型，feign不能直接支持这种参数的传递，因此需要导入相关配置和配置文件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--feign支持Multipart格式传参--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign.form<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-form<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign.form<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-form-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>导入完成后在调用方的启动类上加入注解支持Feign远程调用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients(basePackages = &#123;&quot;com.xuecheng.content.feignclient&quot;&#125;)</span></span><br></pre></td></tr></table></figure>

<p>然后编写feign接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;media&quot;, configuration = &#123;MultipartSupportConfig.class&#125;, fallbackFactory = MediaServiceFallbackFactory.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MediaServiceClient</span> &#123;</span><br><span class="line">    <span class="meta">@ApiOperation(&quot;上传文件&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;/media/upload/coursefile&quot;, consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span></span><br><span class="line">    String <span class="title function_">upload</span><span class="params">(<span class="meta">@RequestPart(&quot;filedata&quot;)</span> MultipartFile upload, <span class="meta">@RequestParam(value = &quot;objectName&quot;, required = false)</span> String objectName)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里<code>@FeignClient</code>注解中<code>value</code>要写清楚要调用的服务的名称，<code>configuration</code>是支持传输文件的配置文件类。</p>
<p>然后使用<code>SpringMVC</code>的格式定义调用接口。</p>
<p><code>fallbackFactory</code>是熔断降级策略，就是要调用的服务如果挂掉怎么处理，这里的意思就是如果远程服务挂到，就走<code>MediaServiceFallbackFactory</code>中定义的方法。</p>
<p>项目使用<code>Hystrix</code>框架实现熔断、降级处理，关于熔断降级，做完这个项目把<code>springcloud</code>高级篇看看。</p>
<p>对于fallback，有两种策略，如果注解中写fallback&#x3D;xxx.class，那么xxx这个类需要实现feign客户端接口，然后重写被调用的方法；</p>
<p>对于<code>fallbackFactory</code>，那么处理降级的类要实现<code>*FallbackFactory*&lt;*MediaServiceClient*&gt;</code>,泛型写调用的feign，然后重写<code>create</code>,该类的好处是能得到异常信息，方便日志记录。</p>
<p>总结：</p>
<p>​	使用Feign的步骤：</p>
<p>​		① 引入依赖</p>
<p>​		② 添加<code>@EnableFeignClients</code>注解</p>
<p>​		③ 编写<code>FeignClient</code>接口</p>
<p>​		④ 使用<code>FeignClient</code>中定义的方法代替<code>RestTemplate</code></p>
<h2 id="SpringSecurity"><a href="#SpringSecurity" class="headerlink" title="SpringSecurity"></a>SpringSecurity</h2><p>首先导入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>一旦导入依赖，项目就被springSecurity管控。</p>
<h3 id="整合auth2和JWT"><a href="#整合auth2和JWT" class="headerlink" title="整合auth2和JWT"></a>整合auth2和JWT</h3><p>1、导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、导入2个配置类</p>
<p><code>ResourceServerConfig</code></p>
<p><code>TokenConfig</code></p>
<p>3、在<code>ResourceServerConfig</code>中配置要管控的资源路径。</p>
<p>4、启动微服务，该微服务的资源就被auth管控了，如果要访问，需要先到auth服务中申请令牌，然后再携带令牌去访问对应的资源，http请求格式：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET &#123;&#123;gateway_host&#125;&#125;/content/course/1</span><br><span class="line"><span class="attribute">Authorization</span><span class="punctuation">: </span>Bearer eyJhbGciOiJIU</span><br></pre></td></tr></table></figure>

<p>Bearer后面跟token</p>
<h3 id="网关统一认证-没看懂"><a href="#网关统一认证-没看懂" class="headerlink" title="网关统一认证[没看懂]"></a>网关统一认证[没看懂]</h3><p>1、网关添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、读懂网关的过滤器</p>
<p>3、配置白名单</p>
<p>4、在微服务中放行所有请求</p>
<h3 id="用户认证"><a href="#用户认证" class="headerlink" title="用户认证"></a>用户认证</h3><p>security的流程图如下：</p>
<p><img src="https://raw.githubusercontent.com/love-you-3000/picUpload/master/images/image-20230619202705750.png" alt="image-20230619202705750"></p>
<p><img src="https://raw.githubusercontent.com/love-you-3000/picUpload/master/images/image-20211214151515385.png" alt="image-20211214151515385"></p>
<p>默认用户信息是存放在内存中的，因此我们重写<code>UserDetaIlService</code>，该接口有一个<code>loadUserByUsername</code>方法， 传入<code>username</code>返回<code>UserDetails</code>对象，但我们这个项目包含多种认证方式，因此我们统一输入参数，定义为<code>*AuthParamsDto*</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthParamsDto</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String username; <span class="comment">//用户名</span></span><br><span class="line">    <span class="keyword">private</span> String password; <span class="comment">//域  用于扩展</span></span><br><span class="line">    <span class="keyword">private</span> String cellphone;<span class="comment">//手机号</span></span><br><span class="line">    <span class="keyword">private</span> String checkcode;<span class="comment">//验证码</span></span><br><span class="line">    <span class="keyword">private</span> String checkcodekey;<span class="comment">//验证码key</span></span><br><span class="line">    <span class="keyword">private</span> String authType; <span class="comment">// 认证的类型   password:用户名密码模式类型    sms:短信模式类型</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; payload = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();<span class="comment">//附加数据，作为扩展，不同认证类型可拥有不同的附加数据。如认证类型为短信时包含smsKey : sms:3d21042d054548b08477142bbca95cfa; 所有情况下都包含clientId</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是接口只接受String输入，因此我们先将输入转换成对象，再把对应的信息提取出来，因为不同的模式有不同的认证方法， 比如微信认证不需要账号密码，账号密码需要验证验证码等，于是我们定义一个接口<code>*AuthService*</code>，这个接口有一个方法<code>execute</code>，然后写不同的实现类进行不同的认证。</p>
<p>但是不同的实现类都实现了<code>*AuthService*</code>，注入的时候如何区分？</p>
<p>我们可以在实习类的注解上给类加上名字，<code>*@Service*(&quot;password_service&quot;)</code>，然后通过spinrg的上下文来获取bean。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line">    ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">authType</span> <span class="operator">=</span> authParamsDto.getAuthType();</span><br><span class="line"><span class="type">AuthService</span> <span class="variable">authService</span> <span class="operator">=</span> applicationContext.getBean(authType + <span class="string">&quot;_service&quot;</span>, AuthService.class);</span><br></pre></td></tr></table></figure>

<h3 id="验证码认证"><a href="#验证码认证" class="headerlink" title="验证码认证"></a>验证码认证</h3><p>导入验证码模块，注册为微服务，该微服务提供2个接口，一个用来生成验证码，一个用来验证验证码，我们的认证服务需要验证认证码，因此需要用到该微服务中的接口，于是使用feign远程调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;checkcode&quot;,fallbackFactory = CheckCodeClientFactory.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CheckCodeClient</span> &#123;</span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;/checkcode/verify&quot;)</span></span><br><span class="line">    Boolean <span class="title function_">verify</span><span class="params">(<span class="meta">@RequestParam(&quot;key&quot;)</span> String key, <span class="meta">@RequestParam(&quot;code&quot;)</span> String code)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="微信扫码登录"><a href="#微信扫码登录" class="headerlink" title="微信扫码登录"></a>微信扫码登录</h2><h3 id="微信扫码登录流程"><a href="#微信扫码登录流程" class="headerlink" title="微信扫码登录流程"></a>微信扫码登录流程</h3><p><img src="https://raw.githubusercontent.com/love-you-3000/picUpload/master/images/D0wkkHSbtC6VUSHX4WsjP5ssg5mdnEmXO8NGVGF34dxS9N1WCcq6wvquR4K_Hcut" alt="img"></p>
<ul>
<li><p>首先用户扫码登录是第三方应用去<strong>获取授权码</strong>，当打开扫码界面时第三方便会发给微信平台一个get请求，这个请求里面包含一个重定向url参数，然后用户授权登录后，如果同意登录，微信便会将code和state参数发送给这个重定向uri，又第三方接口捕获。</p>
<p><strong>【存疑】这个项目里的重定向url是<code>http://tjxt-user-t.itheima.net/xuecheng/auth/wxLogin</code>，但这个并不是一个公网域名，为什么还可以接收到参数？</strong></p>
<p><strong>项目中的重定向uri需要通过hosts文件映射到本地端口再由nginx路由转发到网关，后端接口才能接收到。</strong></p>
</li>
<li><p>第三方拿到授权码后再访问微信接口获取token，拿到token后携带token访问微信接口获取用户信息，得到用户的基本信息，若该用户不存在数据库，则写入数据库，最后返回用户信息，调用统一认证接口完成认证流程。</p>
</li>
</ul>
<h2 id="用户授权"><a href="#用户授权" class="headerlink" title="用户授权"></a>用户授权</h2><h3 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h3><p>如何将用户和权限以及角色关联起来？</p>
<p>数据库提供五张表，这种设计符合大部分权限设计的系统。</p>
<p><img src="https://raw.githubusercontent.com/love-you-3000/picUpload/master/images/image-20230620145725673.png" alt="image-20230620145725673"></p>
<ul>
<li>xc_user: 存储用户基本信息；</li>
<li>xc_role: 存储角色类型信息，比如学生、老师、管理员等；</li>
<li>xc_user_role: 通过这张表将用户信息和用户的角色信息关联起来，是多对多的关系，一个用户可以有多个角色，一个角色对应多个用户；</li>
<li>xc_menu: 权限信息表。这张表记录着所有的权限信息。</li>
<li>xc_permission: 这张表关联了角色和权限，是多对多关系，一个角色可以拥有多种权限，一种权限可以被多种角色拥有。</li>
</ul>
<h3 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h3><p>在返回userDetails时，将用户权限写入，在需要用户权限的接口上方，通过注解<code>*@PreAuthorize*(&quot;hasAnyAuthority(&#39;xc_teachmanager_course_list&#39;)&quot;)</code>表示需要有什么权限才能访问。</p>
<h2 id="学生选课"><a href="#学生选课" class="headerlink" title="学生选课"></a>学生选课</h2><h2 id="支付宝支付"><a href="#支付宝支付" class="headerlink" title="支付宝支付"></a>支付宝支付</h2><h3 id="执行流程"><a href="#执行流程" class="headerlink" title="执行流程"></a>执行流程</h3><p>学生选择了收费课程后便会进行支付流程，支付流程图：</p>
<p><img src="https://raw.githubusercontent.com/love-you-3000/picUpload/master/images/image-20230622085834542.png" alt="image-20230622085834542"></p>
<p>1、请求学习中心服务创建选课记录</p>
<p>2、请求订单服务创建商品订单、生成支付二维码。</p>
<p>3、用户扫码请求订单支付服务，订单支付服务请求第三方支付平台生成支付订单。</p>
<p>4、前端唤起支付客户端，用户输入密码完成支付。</p>
<p>5、第三方支付平台支付完成发起支付通知。</p>
<p>6、订单支付服务接收第三方支付通知结果。</p>
<p>7、用户在前端查询支付结果，请求订单支付服务查询支付结果。</p>
<p>8、订单支付服务向学习中心服务通知支付结果。</p>
<p>9、学习中心服务收到支付结果，如果支付成功则更新选课记录，并添加到我的课程表。</p>
<h3 id="准备开发环境"><a href="#准备开发环境" class="headerlink" title="准备开发环境"></a>准备开发环境</h3><ol>
<li>配置沙箱环境<ul>
<li>沙箱环境是支付宝开放平台为开发者提供的与生产环境完全隔离的联调测试环境</li>
<li>开发者在沙箱环境中完成的接口调用不会对生产环境中的数据造成任何影响</li>
<li>沙箱环境配置文档：<a target="_blank" rel="noopener" href="https://opendocs.alipay.com/common/02kkv7">https://opendocs.alipay.com/common/02kkv7</a></li>
</ul>
</li>
<li>模拟器<ul>
<li>下载并安装模拟器：<a target="_blank" rel="noopener" href="http://mumu.163.com/">http://mumu.163.com/</a></li>
<li>注意安装目录尽量为全英文</li>
</ul>
</li>
<li>在模拟器中安装沙箱版本的支付宝<ul>
<li>使用沙箱环境的买家账号登录沙箱版本的支付宝</li>
</ul>
</li>
</ol>
<h3 id="创建订单服务"><a href="#创建订单服务" class="headerlink" title="创建订单服务"></a>创建订单服务</h3><p>导入黑马提供的订单服务模块，并修改相关配置</p>
<h3 id="支付接口测试"><a href="#支付接口测试" class="headerlink" title="支付接口测试"></a>支付接口测试</h3><p>手机网站支付接入流程详细参见：<a target="_blank" rel="noopener" href="https://docs.open.alipay.com/203/105285/">https://docs.open.alipay.com/203/105285/</a></p>
<p>接口交互流程如下：</p>
<p><img src="https://raw.githubusercontent.com/love-you-3000/picUpload/master/images/1668414529588-da8c06d7-41da-49b2-a967-00d05d01ff33.png" alt="1667801727425_手机网站支付-支付及消息部分.png"></p>
<ol>
<li><ol>
<li>用户在商户的H5网站下单支付后，商户系统按照手机网站支付接口API的参数规范生成订单数据</li>
<li>前端页面通过Form表单的形式请求到支付宝，此时支付宝会自动将页面跳转至支付宝H5收银台页面，如果用户手机上安装了支付宝，则会自动唤起支付宝App</li>
<li>输入支付密码完成支付</li>
<li>用户在支付宝App或H5收银台完成支付后，会根据商户在手机网站支付API中传入的前台回调地址return_url自动跳转回商户页面，同时在URL请求中以QueryString的形式附带上支付结果参数，详细回调函数参见手机网站支付接口的前台回调函数</li>
<li>支付宝还会根据原始支付Api中传入的异步通知地址notify_url，通过POST请求的形式将支付结果作为参数通知到商户系统，详情见支付结果异步通知</li>
</ol>
</li>
<li><p>接口定义</p>
<ul>
<li><p>文档：<a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/203/107090">https://opendocs.alipay.com/open/203/107090</a></p>
</li>
<li><p>接口定义：外部商户请求支付宝创建订单并支付</p>
</li>
<li><p>请求地址使用沙箱地址：<a target="_blank" rel="noopener" href="https://openapi.alipaydev.com/gateway.do">https://openapi.alipaydev.com/gateway.do</a></p>
</li>
<li><p>请求参数查阅官方文档：</p>
<p><a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/203/107090">https://opendocs.alipay.com/open/203/107090</a></p>
<ul>
<li>一部分由SDK设置，一部分需要编写程序时指定</li>
</ul>
</li>
</ul>
</li>
<li><p>示例代码</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/alipaytest&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest httpRequest, HttpServletResponse httpResponse)</span> <span class="keyword">throws</span> ServletException, IOException, AlipayApiException &#123;</span><br><span class="line">        <span class="type">AlipayClient</span> <span class="variable">alipayClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultAlipayClient</span>(AlipayConfig.URL, APP_ID, APP_PRIVATE_KEY, AlipayConfig.FORMAT, AlipayConfig.CHARSET, ALIPAY_PUBLIC_KEY, AlipayConfig.SIGNTYPE);</span><br><span class="line">        <span class="type">AlipayTradeWapPayRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlipayTradeWapPayRequest</span>();</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">bizContent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        bizContent.put(<span class="string">&quot;out_trade_no&quot;</span>, <span class="string">&quot;20210817010101002&quot;</span>);</span><br><span class="line">        bizContent.put(<span class="string">&quot;total_amount&quot;</span>, <span class="number">12.13</span>);</span><br><span class="line">        bizContent.put(<span class="string">&quot;subject&quot;</span>, <span class="string">&quot;测试商品&quot;</span>);</span><br><span class="line">        bizContent.put(<span class="string">&quot;product_code&quot;</span>, <span class="string">&quot;QUICK_WAP_WAY&quot;</span>);</span><br><span class="line">        request.setBizContent(bizContent.toString());</span><br><span class="line">        <span class="type">String</span> <span class="variable">form</span> <span class="operator">=</span> alipayClient.pageExecute(request).getBody();</span><br><span class="line">        System.out.println(form);</span><br><span class="line">        httpResponse.setContentType(<span class="string">&quot;text/html;charset=UTF-8&quot;</span>);</span><br><span class="line">        httpResponse.getWriter().write(form);<span class="comment">//直接将完整的表单html输出到页面</span></span><br><span class="line">        httpResponse.getWriter().flush();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li><p>编写下单代码</p>
<p>根据接口流程，首先在订单服务编写测试类请求支付宝下单的接口</p>
</li>
</ol>
<p>​	5. 在订单服务api工程中添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 支付宝SDK --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alipay.sdk<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>alipay-sdk-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.7.73.ALL<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 支付宝SDK依赖的日志 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="6">
<li>在订单模块创建<code>*AlipayConfig*</code></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AlipayConfig</span> &#123;</span><br><span class="line">  <span class="comment">// 商户appid</span></span><br><span class="line"><span class="comment">//	public static String APPID = &quot;&quot;;</span></span><br><span class="line">  <span class="comment">// 私钥 pkcs8格式的</span></span><br><span class="line"><span class="comment">//	public static String RSA_PRIVATE_KEY = &quot;&quot;;</span></span><br><span class="line">  <span class="comment">// 服务器异步通知页面路径 需http://或者https://格式的完整路径，不能加?id=123这类自定义参数，必须外网可以正常访问</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">notify_url</span> <span class="operator">=</span> <span class="string">&quot;http://商户网关地址/alipay.trade.wap.pay-JAVA-UTF-8/notify_url.jsp&quot;</span>;</span><br><span class="line">  <span class="comment">// 页面跳转同步通知页面路径 需http://或者https://格式的完整路径，不能加?id=123这类自定义参数，必须外网可以正常访问 商户可以自定义同步跳转地址</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">return_url</span> <span class="operator">=</span> <span class="string">&quot;http://商户网关地址/alipay.trade.wap.pay-JAVA-UTF-8/return_url.jsp&quot;</span>;</span><br><span class="line">  <span class="comment">// 请求网关地址</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">URL</span> <span class="operator">=</span> <span class="string">&quot;https://openapi-sandbox.dl.alipaydev.com/gateway.do&quot;</span>;</span><br><span class="line">  <span class="comment">// 编码</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">CHARSET</span> <span class="operator">=</span> <span class="string">&quot;UTF-8&quot;</span>;</span><br><span class="line">  <span class="comment">// 返回格式</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">FORMAT</span> <span class="operator">=</span> <span class="string">&quot;json&quot;</span>;</span><br><span class="line">  <span class="comment">// 支付宝公钥</span></span><br><span class="line"><span class="comment">//	public static String ALIPAY_PUBLIC_KEY = &quot;&quot;;</span></span><br><span class="line">  <span class="comment">// 日志记录目录</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">log_path</span> <span class="operator">=</span> <span class="string">&quot;/log&quot;</span>;</span><br><span class="line">  <span class="comment">// RSA2</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">SIGNTYPE</span> <span class="operator">=</span> <span class="string">&quot;RSA2&quot;</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>7 在api工程下编写Controller类请求支付宝下单的接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.orders.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.alipay.api.AlipayApiException;</span><br><span class="line"><span class="keyword">import</span> com.alipay.api.AlipayClient;</span><br><span class="line"><span class="keyword">import</span> com.alipay.api.DefaultAlipayClient;</span><br><span class="line"><span class="keyword">import</span> com.alipay.api.request.AlipayTradeWapPayRequest;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.orders.config.AlipayConfig;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@className</span>: PayTestController</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: 朱江</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: 扫码支付测试</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2023/6/21</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayTestController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;pay.alipay.APP_ID&#125;&quot;)</span></span><br><span class="line">    String APP_ID;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;pay.alipay.APP_PRIVATE_KEY&#125;&quot;)</span></span><br><span class="line">    String APP_PRIVATE_KEY;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;pay.alipay.APP_PUBLIC_KEY&#125;&quot;)</span></span><br><span class="line">    String APP_PUBLIC_KEY;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;pay.alipay.ZFB_PUBLIC_KEY&#125;&quot;)</span></span><br><span class="line">    String ALIPAY_PUBLIC_KEY;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/alipaytest&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest httpRequest, HttpServletResponse httpResponse)</span> <span class="keyword">throws</span> ServletException, IOException, AlipayApiException &#123;</span><br><span class="line">        <span class="type">AlipayClient</span> <span class="variable">alipayClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultAlipayClient</span>(AlipayConfig.URL, APP_ID, APP_PRIVATE_KEY, AlipayConfig.FORMAT, AlipayConfig.CHARSET, ALIPAY_PUBLIC_KEY, AlipayConfig.SIGNTYPE);</span><br><span class="line">        <span class="type">AlipayTradeWapPayRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlipayTradeWapPayRequest</span>();</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">bizContent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        bizContent.put(<span class="string">&quot;out_trade_no&quot;</span>, <span class="string">&quot;20210817010101002&quot;</span>);</span><br><span class="line">        bizContent.put(<span class="string">&quot;total_amount&quot;</span>, <span class="number">12.13</span>);</span><br><span class="line">        bizContent.put(<span class="string">&quot;subject&quot;</span>, <span class="string">&quot;测试商品&quot;</span>);</span><br><span class="line">        bizContent.put(<span class="string">&quot;product_code&quot;</span>, <span class="string">&quot;QUICK_WAP_WAY&quot;</span>);</span><br><span class="line">        request.setBizContent(bizContent.toString());</span><br><span class="line">        <span class="type">String</span> <span class="variable">form</span> <span class="operator">=</span> alipayClient.pageExecute(request).getBody();</span><br><span class="line">        System.out.println(form);</span><br><span class="line">        httpResponse.setContentType(<span class="string">&quot;text/html;charset=UTF-8&quot;</span>);</span><br><span class="line">        httpResponse.getWriter().write(form);<span class="comment">//直接将完整的表单html输出到页面</span></span><br><span class="line">        httpResponse.getWriter().flush();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>在nacos中配置APPID等参数，这些KEY可以从支付宝沙箱官网拿到。</li>
<li>生成二维码</li>
</ol>
<ul>
<li><p>用户在前端使用支付宝沙箱环境，通过扫码请求下单接口，我们需要生成订单服务的下单接口二维码</p>
</li>
<li><p>ZXing是一个开源的类库，是用Java编写的多格式的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1D/2D</span><br></pre></td></tr></table></figure>

<p>条码图像处理库，使用ZXing可以生成、识别QR Code（二维码）</p>
</li>
</ul>
<p>9.1 在base工程中引入ZXing的依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">XML</span><br><span class="line">&lt;!-- 二维码生成&amp;识别组件 --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.google.zxing&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;core&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;3.3.3&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.google.zxing&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;javase&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;3.3.3&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;commons-lang3&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>拷贝黑马提供的工具类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">QRCodeUtil.java</span><br></pre></td></tr></table></figure>

<p>到base工程的utils包下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">JAVA</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QRCodeUtil</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 生成二维码</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> content 二维码对应的URL</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> width   二维码图片宽度</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> height  二维码图片高度</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">createQRCode</span><span class="params">(String content, <span class="type">int</span> width, <span class="type">int</span> height)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">resultImage</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="comment">//除了尺寸，传入内容不能为空</span></span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(content)) &#123;</span><br><span class="line">            <span class="type">ServletOutputStream</span> <span class="variable">stream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="type">ByteArrayOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            <span class="comment">//二维码参数</span></span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;rawtypes&quot;)</span></span><br><span class="line">            HashMap&lt;EncodeHintType, Comparable&gt; hints = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            <span class="comment">//指定字符编码为“utf-8”</span></span><br><span class="line">            hints.put(EncodeHintType.CHARACTER_SET, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">            <span class="comment">//L M Q H四个纠错等级从低到高，指定二维码的纠错等级为M</span></span><br><span class="line">            <span class="comment">//纠错级别越高，可以修正的错误就越多，需要的纠错码的数量也变多，相应的二维吗可储存的数据就会减少</span></span><br><span class="line">            hints.put(EncodeHintType.ERROR_CORRECTION, ErrorCorrectionLevel.M);</span><br><span class="line">            <span class="comment">//设置图片的边距</span></span><br><span class="line">            hints.put(EncodeHintType.MARGIN, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//zxing生成二维码核心类</span></span><br><span class="line">                <span class="type">QRCodeWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QRCodeWriter</span>();</span><br><span class="line">                <span class="comment">//把输入文本按照指定规则转成二维吗</span></span><br><span class="line">                <span class="type">BitMatrix</span> <span class="variable">bitMatrix</span> <span class="operator">=</span> writer.encode(content, BarcodeFormat.QR_CODE, width, height, hints);</span><br><span class="line">                <span class="comment">//生成二维码图片流</span></span><br><span class="line">                <span class="type">BufferedImage</span> <span class="variable">bufferedImage</span> <span class="operator">=</span> MatrixToImageWriter.toBufferedImage(bitMatrix);</span><br><span class="line">                <span class="comment">//输出流</span></span><br><span class="line">                ImageIO.write(bufferedImage, <span class="string">&quot;png&quot;</span>, os);</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                * 原生转码前面没有 data:image/png;base64 这些字段，返回给前端是无法被解析，所以加上前缀</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">                resultImage = <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;data:image/png;base64,&quot;</span> + EncryptUtil.encodeBase64(os.toByteArray()));</span><br><span class="line">                <span class="keyword">return</span> resultImage;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;生成二维码出错&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (stream != <span class="literal">null</span>) &#123;</span><br><span class="line">                    stream.flush();</span><br><span class="line">                    stream.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>9.2 速览一遍代码，我们只需要传入跳转url、图片的长宽，就会生成一个base64编码的图片，我们可以在浏览器中打开并扫码，现在编写一个main方法进行测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"> <span class="type">QRCodeUtil</span> <span class="variable">qrCodeUtil</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QRCodeUtil</span>();</span><br><span class="line"> System.out.println(qrCodeUtil.createQRCode(<span class="string">&quot;http://192.168.101.1:63030/orders/alipaytest&quot;</span>, <span class="number">200</span>, <span class="number">200</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述程序生成的二维码就会在扫码后访问controller中的接口进行支付。</p>
<h3 id="支付结果通知"><a href="#支付结果通知" class="headerlink" title="支付结果通知"></a>支付结果通知</h3><h4 id="设置接受通知地址"><a href="#设置接受通知地址" class="headerlink" title="设置接受通知地址"></a>设置接受通知地址</h4><p>用户在支付宝方支付后，我们项目需要得知支付结果，在Alipaytest中加入</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.setNotifyUrl(<span class="string">&quot;http://rtah69.natappfree.cc/orders/paynotify&quot;</span>); <span class="comment">// 内网穿透地址，支付结果访问本地63030的orders/paynotify接口</span></span><br></pre></td></tr></table></figure>

<p>也就是设置通知地址，支付宝那边在支付结束后，会把支付结果post到这个接口，因为我们的项目是内网，所以需要启动内网穿透工具，<code>http://rtah69.natappfree.cc</code>映射到本地63030端口</p>
<p><img src="https://raw.githubusercontent.com/love-you-3000/picUpload/master/images/image-20230623101520705.png" alt="image-20230623101520705"></p>
<ul>
<li>对于手机网站支付产生的交易，支付宝会通知商户支付结果，有两种方式<ol>
<li>return_url：使用此方式时，不能保证通知到位，所以建议使用notify_url</li>
<li>notify_url</li>
</ol>
</li>
</ul>
<table>
<thead>
<tr>
<th align="center">return_url</th>
<th align="center">notify_url</th>
</tr>
</thead>
<tbody><tr>
<td align="center">支付成功后点击完成会自动跳转回商家页面地址，同时在URL地址上附带支付结果参数，回跳参数可查看本文前台回跳参数说明。在iOS系统中，唤起支付宝客户端支付完成后，不会自动回到浏览器或商家App。用户可手工切回到浏览器或商家App。</td>
<td align="center">异步通知地址，用于接收支付宝推送给商户的支付&#x2F;退款成功的消息。</td>
</tr>
</tbody></table>
<ul>
<li>具体的使用方法是在调用下单接口的API中传入异步通知地址notify_url，通过POST请求的形式将支付结果作为参数通知到商户系统<ul>
<li>详情参阅：<a target="_blank" rel="noopener" href="https://opendocs.alipay.com/support/01raw4">支付宝异步通知说明</a></li>
</ul>
</li>
<li>根据下单执行流程，订单服务收到支付结果需要对内容进行验签，验签过程如下<ol>
<li>在通知返回参数列表中，出去sign、sign_type两个参数外，凡是通知返回胡来的参数均为待验签的参数。将剩下的参数进行url_decode，然后按照字典排序，组成字符串，得到待签名字符串；生活号异步通知组成的待验签串中须保留sign_type参数</li>
<li>将签名参数（sigin）使用base64解码为字节码串</li>
<li>使用RSA的验签方法，通过签名字符串、签名参数（通过base64解码）及支付宝公钥验证签名</li>
<li>验证签名正确后，必须再严格按照如下描述校验通知数据的正确性<ul>
<li>商户必须根据支付宝不同类型的业务通知，正确的进行不同的业务处理，并且过滤重复的通知结果数据。</li>
<li>通过验证out_trade_no、total_amount、appid参数的正确性判断通知请求的合法性。</li>
</ul>
</li>
</ol>
</li>
</ul>
<h4 id="编写接受接口"><a href="#编写接受接口" class="headerlink" title="编写接受接口"></a>编写接受接口</h4><p>参考支付宝提供的demo编写</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/paynotify&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">paynotify</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException, AlipayApiException &#123;</span><br><span class="line">       Map&lt;String, String&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">       <span class="type">Map</span> <span class="variable">requestParams</span> <span class="operator">=</span> request.getParameterMap();</span><br><span class="line">       <span class="keyword">for</span> (<span class="type">Iterator</span> <span class="variable">iter</span> <span class="operator">=</span> requestParams.keySet().iterator(); iter.hasNext(); ) &#123;</span><br><span class="line">           <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> (String) iter.next();</span><br><span class="line">           String[] values = (String[]) requestParams.get(name);</span><br><span class="line">           <span class="type">String</span> <span class="variable">valueStr</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">           <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; values.length; i++) &#123;</span><br><span class="line">               valueStr = (i == values.length - <span class="number">1</span>) ? valueStr + values[i]</span><br><span class="line">                       : valueStr + values[i] + <span class="string">&quot;,&quot;</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">//乱码解决，这段代码在出现乱码时使用。如果mysign和sign不相等也可以使用这段代码转化</span></span><br><span class="line">           <span class="comment">//valueStr = new String(valueStr.getBytes(&quot;ISO-8859-1&quot;), &quot;gbk&quot;);</span></span><br><span class="line">           params.put(name, valueStr);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       <span class="comment">//获取支付宝的通知返回参数，可参考技术文档中页面跳转同步通知参数列表(以上仅供参考)//</span></span><br><span class="line">       <span class="comment">//计算得出通知验证结果</span></span><br><span class="line">       <span class="comment">//boolean AlipaySignature.rsaCheckV1(Map&lt;String, String&gt; params, String publicKey, String charset, String sign_type)</span></span><br><span class="line">       <span class="type">boolean</span> <span class="variable">verify_result</span> <span class="operator">=</span> AlipaySignature.rsaCheckV1(params, ALIPAY_PUBLIC_KEY, AlipayConfig.CHARSET, <span class="string">&quot;RSA2&quot;</span>);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (verify_result) &#123;<span class="comment">//验证成功</span></span><br><span class="line">           <span class="comment">//////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line">           <span class="comment">//请在这里加上商户的业务逻辑程序代码</span></span><br><span class="line"></span><br><span class="line">           <span class="comment">//商户订单号</span></span><br><span class="line">           <span class="type">String</span> <span class="variable">out_trade_no</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(request.getParameter(<span class="string">&quot;out_trade_no&quot;</span>).getBytes(<span class="string">&quot;ISO-8859-1&quot;</span>), <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">           <span class="comment">//支付宝交易号</span></span><br><span class="line"></span><br><span class="line">           <span class="type">String</span> <span class="variable">trade_no</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(request.getParameter(<span class="string">&quot;trade_no&quot;</span>).getBytes(<span class="string">&quot;ISO-8859-1&quot;</span>), <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line"></span><br><span class="line">           <span class="comment">//交易状态</span></span><br><span class="line">           <span class="type">String</span> <span class="variable">trade_status</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(request.getParameter(<span class="string">&quot;trade_status&quot;</span>).getBytes(<span class="string">&quot;ISO-8859-1&quot;</span>), <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">           <span class="comment">//——请根据您的业务逻辑来编写程序（以下代码仅作参考）——</span></span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (trade_status.equals(<span class="string">&quot;TRADE_FINISHED&quot;</span>)) &#123;<span class="comment">//交易结束</span></span><br><span class="line">               <span class="comment">//判断该笔订单是否在商户网站中已经做过处理</span></span><br><span class="line">               <span class="comment">//如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序</span></span><br><span class="line">               <span class="comment">//请务必判断请求时的total_fee、seller_id与通知时获取的total_fee、seller_id为一致的</span></span><br><span class="line">               <span class="comment">//如果有做过处理，不执行商户的业务程序</span></span><br><span class="line"></span><br><span class="line">               <span class="comment">//注意：</span></span><br><span class="line">               <span class="comment">//如果签约的是可退款协议，退款日期超过可退款期限后（如三个月可退款），支付宝系统发送该交易状态通知</span></span><br><span class="line">               <span class="comment">//如果没有签约可退款协议，那么付款完成后，支付宝系统发送该交易状态通知。</span></span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (trade_status.equals(<span class="string">&quot;TRADE_SUCCESS&quot;</span>)) &#123;<span class="comment">//交易成功</span></span><br><span class="line">               System.out.println(trade_status + <span class="string">&quot;交易成功&quot;</span>);</span><br><span class="line">               <span class="comment">//判断该笔订单是否在商户网站中已经做过处理</span></span><br><span class="line">               <span class="comment">//如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序</span></span><br><span class="line">               <span class="comment">//请务必判断请求时的total_fee、seller_id与通知时获取的total_fee、seller_id为一致的</span></span><br><span class="line">               <span class="comment">//如果有做过处理，不执行商户的业务程序</span></span><br><span class="line"></span><br><span class="line">               <span class="comment">//注意：</span></span><br><span class="line">               <span class="comment">//如果签约的是可退款协议，那么付款完成后，支付宝系统发送该交易状态通知。</span></span><br><span class="line">           &#125;</span><br><span class="line">           response.getWriter().write(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           response.getWriter().write(<span class="string">&quot;fail&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="生成支付二维码"><a href="#生成支付二维码" class="headerlink" title="生成支付二维码"></a>生成支付二维码</h3><h4 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h4><p>用户点击支付宝支付按钮后会生成对应的支付二维码，支付流程为</p>
<p><img src="https://raw.githubusercontent.com/love-you-3000/picUpload/master/images/image-20230623105451027.png" alt="image-20230623105451027"> </p>
<p>然后用户进行支付，流程为</p>
<p><img src="https://raw.githubusercontent.com/love-you-3000/picUpload/master/images/image-20230623105526629.png" alt="image-20230623105526629"></p>
<p>这里说一下支付记录这张表，要实现这两项需求需要用到3张表。</p>
<p>1、订单表</p>
<p><img src="https://raw.githubusercontent.com/love-you-3000/picUpload/master/images/image-20230623105654004.png" alt="image-20230623105654004"></p>
<p>2、订单明细表</p>
<p><img src="https://raw.githubusercontent.com/love-you-3000/picUpload/master/images/image-20230623105743236.png" alt="image-20230623105743236"></p>
<p>3、支付记录表</p>
<p><img src="https://raw.githubusercontent.com/love-you-3000/picUpload/master/images/image-20230623105840784.png" alt="image-20230623105840784"></p>
<p>如果把订单号作为交易号请求支付宝，如果在系统出现异常导致支付失败，再重新上传订单号就会因为订单重复而无法继续支付，因此采用支付记录表中的pay_no，每次下单都会生成新的编号，但是对应的同一个订单，订单表个支付记录表是一对多的关系。</p>
<p><img src="https://raw.githubusercontent.com/love-you-3000/picUpload/master/images/image-20230623110109180.png" alt="image-20230623110109180"></p>
<p>订单号注意唯一性、安全性、尽量短等特点，生成方案常用的如下：</p>
<p>1、时间戳+随机数</p>
<p>年月日时分秒毫秒+随机数</p>
<p>2、高并发场景</p>
<p>年月日时分秒毫秒+随机数+redis自增序列</p>
<p>3、订单号中加上业务标识</p>
<p>订单号加上业务标识方便客服，比如：第10位是业务类型，第11位是用户类型等。</p>
<p>4、雪花算法</p>
<p>雪花算法是推特内部使用的分布式环境下的唯一ID生成算法，它基于时间戳生成，保证有序递增，加以入计算机硬件等元素，可以满足高并发环境下ID不重复。</p>
<p>本项目订单号生成采用雪花算法。</p>
<h4 id="编写接口"><a href="#编写接口" class="headerlink" title="编写接口"></a>编写接口</h4><p>这部分主要是对3张表的写入，注意好事务处理以及检查字段有效性等细节，具体代码课看仓库。</p>
<h3 id="扫描二维码"><a href="#扫描二维码" class="headerlink" title="扫描二维码"></a>扫描二维码</h3><p>当用户扫码二维码，便会唤起支付页面，支付成功后，分为主动查询支付结果以及被动查询支付结果。</p>
<h4 id="主动查询支付结果"><a href="#主动查询支付结果" class="headerlink" title="主动查询支付结果"></a>主动查询支付结果</h4><p>用户可以主动查询支付结果，当主动查询时，接口需要做2件事，查询支付结果，保存支付结果。这部分代码不好测试，主要知道思想。</p>
<h4 id="被动接受通知"><a href="#被动接受通知" class="headerlink" title="被动接受通知"></a>被动接受通知</h4><p>支付完成后第三方支付系统会主动通知支付结果，要实现主动通知需要在请求支付系统下单时传入NotifyUrl，这里有两个url：NotifyUrl和ReturnUrl，ReturnUrl是支付完成后支付系统携带支付结果重定向到ReturnUrl地址，NotifyUrl是支付完成后支付系统在后台定时去通知，使用NotifyUrl比使用ReturnUrl有保证。</p>
<p>首先在下单时指定NotifyUrl（这里还是需要内网穿透工具）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">JAVA</span><br><span class="line">alipayRequest.setNotifyUrl(&quot;http://66vyk5.natappfree.cc/orders/paynotify&quot;);</span><br></pre></td></tr></table></figure>

<p>接收支付结果通知接口如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">JAVA</span><br><span class="line">@PostMapping(&quot;/paynotify&quot;)</span><br><span class="line">public void paynotify(HttpServletRequest request, HttpServletResponse response) throws IOException, AlipayApiException &#123;</span><br><span class="line">    Map&lt;String, String&gt; params = new HashMap&lt;&gt;();</span><br><span class="line">    Map requestParams = request.getParameterMap();</span><br><span class="line">    for (Iterator iter = requestParams.keySet().iterator(); iter.hasNext(); ) &#123;</span><br><span class="line">        String name = (String) iter.next();</span><br><span class="line">        String[] values = (String[]) requestParams.get(name);</span><br><span class="line">        String valueStr = &quot;&quot;;</span><br><span class="line">        for (int i = 0; i &lt; values.length; i++) &#123;</span><br><span class="line">            valueStr = (i == values.length - 1) ? valueStr + values[i]</span><br><span class="line">                    : valueStr + values[i] + &quot;,&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        params.put(name, valueStr);</span><br><span class="line">    &#125;</span><br><span class="line">    boolean verify_result = AlipaySignature.rsaCheckV1(params, ALIPAY_PUBLIC_KEY, AlipayConfig.CHARSET, &quot;RSA2&quot;);</span><br><span class="line"></span><br><span class="line">    if (verify_result) &#123;</span><br><span class="line">        //商户订单号</span><br><span class="line">        String out_trade_no = new String(request.getParameter(&quot;out_trade_no&quot;).getBytes(&quot;ISO-8859-1&quot;), &quot;UTF-8&quot;);</span><br><span class="line">        //支付宝交易号</span><br><span class="line">        String trade_no = new String(request.getParameter(&quot;trade_no&quot;).getBytes(&quot;ISO-8859-1&quot;), &quot;UTF-8&quot;);</span><br><span class="line">        //交易状态</span><br><span class="line">        String trade_status = new String(request.getParameter(&quot;trade_status&quot;).getBytes(&quot;ISO-8859-1&quot;), &quot;UTF-8&quot;);</span><br><span class="line">        //付款金额</span><br><span class="line">        String total_amount = new String(request.getParameter(&quot;total_amount&quot;).getBytes(&quot;ISO-8859-1&quot;), &quot;UTF-8&quot;);</span><br><span class="line">        if (trade_status.equals(&quot;TRADE_FINISHED&quot;)) &#123;//交易结束</span><br><span class="line"></span><br><span class="line">        &#125; else if (trade_status.equals(&quot;TRADE_SUCCESS&quot;)) &#123;</span><br><span class="line">            // 交易成功，保存订单信息</span><br><span class="line">            PayStatusDto payStatusDto = new PayStatusDto();</span><br><span class="line">            payStatusDto.setOut_trade_no(out_trade_no);</span><br><span class="line">            payStatusDto.setTrade_no(trade_no);</span><br><span class="line">            payStatusDto.setApp_id(APP_ID);</span><br><span class="line">            payStatusDto.setTrade_status(trade_status);</span><br><span class="line">            payStatusDto.setTotal_amount(total_amount);</span><br><span class="line">            orderService.saveAlipayStatus(payStatusDto);</span><br><span class="line">            log.debug(&quot;交易成功&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        response.getWriter().write(&quot;success&quot;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        response.getWriter().write(&quot;fail&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>学成在线</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="https://love-you-3000.github.io/2023/06/22/xc_project/">https://love-you-3000.github.io/2023/06/22/xc_project/</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>作者</h><div class="post-copyright-cc-info"><h>Jiang</h></div></div><div class="post-copyright-c"><h>发布于</h><div class="post-copyright-cc-info"><h>2023-06-22</h></div></div><div class="post-copyright-u"><h>更新于</h><div class="post-copyright-cc-info"><h>2023-06-23</h></div></div><div class="post-copyright-c"><h>许可协议</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/JAVA/">JAVA</a><a class="post-meta__tags" href="/tags/%E9%A1%B9%E7%9B%AE/">项目</a></div><div class="post_share"><div class="social-share" data-image="/img/xc_cover.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-full"><a href="/2023/06/22/nowcoder/" title="牛客网项目"><img class="cover" src="/img/nowcoder.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">牛客网项目</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/06/22/nowcoder/" title="牛客网项目"><img class="cover" src="/img/nowcoder.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-22</div><div class="title">牛客网项目</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Jiang</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">2</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">2</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">1</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/love-you-3000"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/love-you-3000" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:18834198033@163.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">欢迎来到我的博客^_^</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%A8%E5%9F%9F%E8%AF%B7%E6%B1%82"><span class="toc-number">1.</span> <span class="toc-text">跨域请求</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E8%B7%A8%E5%9F%9F%E8%AF%B7%E6%B1%82"><span class="toc-number">1.1.</span> <span class="toc-text">什么是跨域请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E8%B7%A8%E5%9F%9F%E8%AF%B7%E6%B1%82%E6%96%B9%E6%A1%88"><span class="toc-number">1.2.</span> <span class="toc-text">解决跨域请求方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%9F%E4%B8%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">2.</span> <span class="toc-text">统一异常处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JSR-303%E6%A0%A1%E9%AA%8C"><span class="toc-number">3.</span> <span class="toc-text">JSR-303校验</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%AD%A5%E9%AA%A4"><span class="toc-number">3.1.</span> <span class="toc-text">使用步骤</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E7%BB%84%E6%A0%A1%E9%AA%8C"><span class="toc-number">4.</span> <span class="toc-text">分组校验</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E7%BB%84%E6%A0%A1%E9%AA%8C%E6%AD%A5%E9%AA%A4"><span class="toc-number">4.1.</span> <span class="toc-text">分组校验步骤</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nacos%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%8F%91%E7%8E%B0"><span class="toc-number">5.</span> <span class="toc-text">Nacos服务注册发现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E7%9B%B8%E5%85%B3pom%E5%8C%85"><span class="toc-number">5.1.</span> <span class="toc-text">导入相关pom包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEnacos%E5%9C%B0%E5%9D%80"><span class="toc-number">5.2.</span> <span class="toc-text">配置nacos地址</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nacos%E7%BB%9F%E4%B8%80%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86"><span class="toc-number">6.</span> <span class="toc-text">Nacos统一配置管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5pom%E5%8C%85"><span class="toc-number">6.1.</span> <span class="toc-text">导入pom包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0bootstrap-yaml"><span class="toc-number">6.2.</span> <span class="toc-text">添加bootstrap.yaml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nacos%E7%94%9F%E6%88%90%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">6.3.</span> <span class="toc-text">nacos生成配置文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E5%85%B3gateway"><span class="toc-number">7.</span> <span class="toc-text">网关gateway</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B0%E5%BB%BA%E7%BD%91%E5%85%B3%E6%A8%A1%E5%9D%97%EF%BC%8C%E5%AF%BC%E5%85%A5pom"><span class="toc-number">7.1.</span> <span class="toc-text">新建网关模块，导入pom</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%BD%91%E5%85%B3%E7%9A%84bootstrap-yaml%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">7.2.</span> <span class="toc-text">配置网关的bootstrap.yaml配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nacos%E9%85%8D%E7%BD%AEgateway%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">7.3.</span> <span class="toc-text">nacos配置gateway配置文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%E3%80%90%E9%87%8D%E7%82%B9%E3%80%91"><span class="toc-number">8.</span> <span class="toc-text">上传文件【重点】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Minio%E4%BA%91%E5%AD%98%E5%82%A8"><span class="toc-number">8.1.</span> <span class="toc-text">Minio云存储</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87"><span class="toc-number">8.2.</span> <span class="toc-text">上传图片</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E7%B1%BB%E5%9E%8B"><span class="toc-number">8.2.1.</span> <span class="toc-text">接口类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86"><span class="toc-number">8.2.2.</span> <span class="toc-text">文件处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6"><span class="toc-number">8.2.3.</span> <span class="toc-text">上传文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E4%BC%98%E5%8C%96"><span class="toc-number">8.2.4.</span> <span class="toc-text">事务优化</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E3%80%90%E9%9D%A2%E8%AF%95%E9%A2%98%E3%80%91-%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99spring%E4%BA%8B%E5%8A%A1%E4%BC%9A%E5%A4%B1%E6%95%88"><span class="toc-number">9.</span> <span class="toc-text">【面试题】 什么时候spring事务会失效</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring%E4%BA%8B%E5%8A%A1"><span class="toc-number">9.1.</span> <span class="toc-text">Spring事务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E8%A1%8C%E4%B8%BA"><span class="toc-number">9.2.</span> <span class="toc-text">事务传播行为</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E4%BA%8B%E5%8A%A1%E4%BC%9A%E5%A4%B1%E6%95%88"><span class="toc-number">9.3.</span> <span class="toc-text">什么时候事务会失效</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0"><span class="toc-number">10.</span> <span class="toc-text">断点续传</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0%E6%B5%81%E7%A8%8B"><span class="toc-number">10.1.</span> <span class="toc-text">断点续传流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%86%E9%A2%91%E8%BD%AC%E7%A0%81%E5%A4%84%E7%90%86"><span class="toc-number">11.</span> <span class="toc-text">视频转码处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#xxl-job"><span class="toc-number">11.1.</span> <span class="toc-text">xxl-job</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%AD%E5%BB%BAxxl-job"><span class="toc-number">11.2.</span> <span class="toc-text">搭建xxl-job</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E8%B0%83%E5%BA%A6%E4%B8%AD%E5%BF%83"><span class="toc-number">11.2.1.</span> <span class="toc-text">搭建调度中心</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%89%A7%E8%A1%8C%E5%99%A8"><span class="toc-number">11.2.2.</span> <span class="toc-text">创建执行器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E4%BB%BB%E5%8A%A1"><span class="toc-number">11.2.3.</span> <span class="toc-text">执行任务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88"><span class="toc-number">11.3.</span> <span class="toc-text">技术方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%86%E9%A2%91%E5%A4%84%E7%90%86%E6%96%B9%E6%A1%88"><span class="toc-number">11.4.</span> <span class="toc-text">视频处理方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-5-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-number">11.5.</span> <span class="toc-text">10.5 分布式锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-6-%E8%A7%86%E9%A2%91%E5%A4%84%E7%90%86"><span class="toc-number">11.6.</span> <span class="toc-text">10.6 视频处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E3%80%90%E9%9D%A2%E8%AF%95%E9%A2%98%E3%80%91%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%B9%82%E7%AD%89%E6%80%A7"><span class="toc-number">12.</span> <span class="toc-text">【面试题】如何实现幂等性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E4%B8%80%EF%BC%9A%E6%95%B0%E6%8D%AE%E5%BA%93%E5%94%AF%E4%B8%80%E4%B8%BB%E9%94%AE"><span class="toc-number">12.1.</span> <span class="toc-text">方案一：数据库唯一主键</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E4%BA%8C%EF%BC%9A%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B9%90%E8%A7%82%E9%94%81"><span class="toc-number">12.2.</span> <span class="toc-text">方案二：数据库乐观锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E4%B8%89%EF%BC%9A%E9%98%B2%E9%87%8D-Token-%E4%BB%A4%E7%89%8C"><span class="toc-number">12.3.</span> <span class="toc-text">方案三：防重 Token 令牌</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Feign%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8"><span class="toc-number">13.</span> <span class="toc-text">Feign远程调用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringSecurity"><span class="toc-number">14.</span> <span class="toc-text">SpringSecurity</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B4%E5%90%88auth2%E5%92%8CJWT"><span class="toc-number">14.1.</span> <span class="toc-text">整合auth2和JWT</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E5%85%B3%E7%BB%9F%E4%B8%80%E8%AE%A4%E8%AF%81-%E6%B2%A1%E7%9C%8B%E6%87%82"><span class="toc-number">14.2.</span> <span class="toc-text">网关统一认证[没看懂]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81"><span class="toc-number">14.3.</span> <span class="toc-text">用户认证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E7%A0%81%E8%AE%A4%E8%AF%81"><span class="toc-number">14.4.</span> <span class="toc-text">验证码认证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%AE%E4%BF%A1%E6%89%AB%E7%A0%81%E7%99%BB%E5%BD%95"><span class="toc-number">15.</span> <span class="toc-text">微信扫码登录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%AE%E4%BF%A1%E6%89%AB%E7%A0%81%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B"><span class="toc-number">15.1.</span> <span class="toc-text">微信扫码登录流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E6%8E%88%E6%9D%83"><span class="toc-number">16.</span> <span class="toc-text">用户授权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="toc-number">16.1.</span> <span class="toc-text">数据模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%88%E6%9D%83"><span class="toc-number">16.2.</span> <span class="toc-text">授权</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%A6%E7%94%9F%E9%80%89%E8%AF%BE"><span class="toc-number">17.</span> <span class="toc-text">学生选课</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%AF%E4%BB%98%E5%AE%9D%E6%94%AF%E4%BB%98"><span class="toc-number">18.</span> <span class="toc-text">支付宝支付</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">18.1.</span> <span class="toc-text">执行流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83"><span class="toc-number">18.2.</span> <span class="toc-text">准备开发环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1"><span class="toc-number">18.3.</span> <span class="toc-text">创建订单服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%AF%E4%BB%98%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95"><span class="toc-number">18.4.</span> <span class="toc-text">支付接口测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%AF%E4%BB%98%E7%BB%93%E6%9E%9C%E9%80%9A%E7%9F%A5"><span class="toc-number">18.5.</span> <span class="toc-text">支付结果通知</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E6%8E%A5%E5%8F%97%E9%80%9A%E7%9F%A5%E5%9C%B0%E5%9D%80"><span class="toc-number">18.5.1.</span> <span class="toc-text">设置接受通知地址</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E6%8E%A5%E5%8F%97%E6%8E%A5%E5%8F%A3"><span class="toc-number">18.5.2.</span> <span class="toc-text">编写接受接口</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E6%94%AF%E4%BB%98%E4%BA%8C%E7%BB%B4%E7%A0%81"><span class="toc-number">18.6.</span> <span class="toc-text">生成支付二维码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-number">18.6.1.</span> <span class="toc-text">需求分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E6%8E%A5%E5%8F%A3"><span class="toc-number">18.6.2.</span> <span class="toc-text">编写接口</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%AB%E6%8F%8F%E4%BA%8C%E7%BB%B4%E7%A0%81"><span class="toc-number">18.7.</span> <span class="toc-text">扫描二维码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BB%E5%8A%A8%E6%9F%A5%E8%AF%A2%E6%94%AF%E4%BB%98%E7%BB%93%E6%9E%9C"><span class="toc-number">18.7.1.</span> <span class="toc-text">主动查询支付结果</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A2%AB%E5%8A%A8%E6%8E%A5%E5%8F%97%E9%80%9A%E7%9F%A5"><span class="toc-number">18.7.2.</span> <span class="toc-text">被动接受通知</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/06/22/nowcoder/" title="牛客网项目"><img src="/img/nowcoder.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="牛客网项目"/></a><div class="content"><a class="title" href="/2023/06/22/nowcoder/" title="牛客网项目">牛客网项目</a><time datetime="2023-06-22T10:24:35.000Z" title="发表于 2023-06-22 18:24:35">2023-06-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/06/22/xc_project/" title="学成在线"><img src="/img/xc_cover.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="学成在线"/></a><div class="content"><a class="title" href="/2023/06/22/xc_project/" title="学成在线">学成在线</a><time datetime="2023-06-22T06:10:20.000Z" title="发表于 2023-06-22 14:10:20">2023-06-22</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Jiang</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>function getGiscusTheme (theme) {
  return theme === 'dark' ? 'dark' : 'light'
}

function loadGiscus () {
  const config = Object.assign({
    src: 'https://giscus.app/client.js',
    'data-repo': 'love-you-3000/giscus',
    'data-repo-id': 'R_kgDOJzFPYQ',
    'data-category-id': 'DIC_kwDOJzFPYc4CXas5',
    'data-mapping': 'pathname',
    'data-theme': getGiscusTheme(document.documentElement.getAttribute('data-theme')),
    'data-reactions-enabled': '1',
    crossorigin: 'anonymous',
    async: true
  },null)

  let ele = document.createElement('script')
  for (let key in config) {
    ele.setAttribute(key, config[key])
  }
  document.getElementById('giscus-wrap').insertAdjacentElement('afterbegin',ele)
}

function changeGiscusTheme (theme) {
  function sendMessage(message) {
    const iframe = document.querySelector('iframe.giscus-frame')
    if (!iframe) return
    iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app')
  }

  sendMessage({
    setConfig: {
      theme: getGiscusTheme(theme)
    }
  });
}

btf.addModeChange('giscus', changeGiscusTheme)

if ('Giscus' === 'Giscus' || !true) {
  if (true) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
  else loadGiscus()
} else {
  function loadOtherComment () {
    loadGiscus()
  }
}</script></div><script defer src="/js/cursor.js"></script><script async src="/js/title.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="false" data-text="I,LOVE,YOU" data-fontsize="15px" data-random="false" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_clock_anzhiyu_injector_config(){
    var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
    var item_html = '<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>';
    console.log('已挂载butterfly_clock_anzhiyu')
    if(parent_div_git) {
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = '/';
  var qweather_key = 'b2dc59ff50b24673b677f4e13ad22962';
  var gaud_map_key = 'e2b04289e870b005374ee030148d64fd&s=rsv3';
  var baidu_ak_key = 'undefined';
  var flag = 0;
  var clock_rectangle = '113.34532,23.15624';
  var clock_default_rectangle_enable = 'false';

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_clock_anzhiyu_injector_config();
  }
  else if (epage === cpage){
    butterfly_clock_anzhiyu_injector_config();
  }
  </script><script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script><script data-pjax src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.js"></script><script data-pjax src="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.js"></script><script data-pjax>
  function gitcalendar_injector_config(){
      var parent_div_git = document.getElementById('recent-posts');
      var item_html = '<div class="recent-post-item" id="gitcalendarBar" style="width:100%;height:auto;padding:10px;"><style>#git_container{min-height: 280px}@media screen and (max-width:650px) {#git_container{min-height: 0px}}</style><div id="git_loading" style="width:10%;height:100%;margin:0 auto;display: block;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animatetransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animatetransform></path></svg><style>#git_container{display: none;}</style></div><div id="git_container"></div></div>';
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
      console.log('已挂载gitcalendar')
      }

    if( document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
        gitcalendar_injector_config()
        GitCalendarInit("https://gitcalendar.fomal.cc/api?Fomalhaut-Blog",['#d9e0df', '#c6e0dc', '#a8dcd4', '#9adcd2', '#89ded1', '#77e0d0', '#5fdecb', '#47dcc6', '#39dcc3', '#1fdabe', '#00dab9'],'Fomalhaut-Blog')
    }
  </script><!-- hexo injector body_end end --></body></html>