<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>MIT6.830-Lab-1 | Jiang's blog</title><meta name="author" content="Jiang"><meta name="copyright" content="Jiang"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="MIT6.830 Lab1实现">
<meta property="og:type" content="article">
<meta property="og:title" content="MIT6.830-Lab-1">
<meta property="og:url" content="https://jiangblog.top/2023/07/15/MIT6-830-lab1/index.html">
<meta property="og:site_name" content="Jiang&#39;s blog">
<meta property="og:description" content="MIT6.830 Lab1实现">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://jiangblog.top/img/lab1.png">
<meta property="article:published_time" content="2023-07-15T06:06:30.000Z">
<meta property="article:modified_time" content="2023-07-15T06:06:30.000Z">
<meta property="article:author" content="Jiang">
<meta property="article:tag" content="MIT6.830">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://jiangblog.top/img/lab1.png"><link rel="shortcut icon" href="/img/hacker.png"><link rel="canonical" href="https://jiangblog.top/2023/07/15/MIT6-830-lab1/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: true
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'MIT6.830-Lab-1',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-07-15 14:06:30'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-double-row-display@1.00/cardlistpost.min.css"/>
<style>#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags:before {content:"\A";
  white-space: pre;}#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags > .article-meta__separator{display:none}</style>
<link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.css" /><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (false) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">24</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">14</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-envelope"></i><span> 留言板</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/lab1.png')"><nav id="nav"><span id="blog-info"><a href="/" title="Jiang's blog"><img class="site-icon" src="/img/logo.png"/><span class="site-name">Jiang's blog</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-envelope"></i><span> 留言板</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">MIT6.830-Lab-1</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-07-15T06:06:30.000Z" title="发表于 2023-07-15 14:06:30">2023-07-15</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-07-15T06:06:30.000Z" title="更新于 2023-07-15 14:06:30">2023-07-15</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/MIT6-830/">MIT6.830</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">8.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>46分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="MIT6.830-Lab-1"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><a target="_blank" rel="noopener" href="https://github.com/MIT-DB-Class/simple-db-hw-2021/blob/master/lab1.md">MIT6.830原文链接</a></p>
<p>在开始实验之前，我们首先在整体上对MIT6.830有一个整体的把控。</p>
<p>课程原文是这样说的</p>
<blockquote>
<p>SimpleDB consists of:</p>
<ul>
<li>Classes that represent fields, tuples, and tuple schemas;</li>
<li>Classes that apply predicates and conditions to tuples;</li>
<li>One or more access methods (e.g., heap files) that store relations on disk and provide a way to iterate through tuples of those relations;</li>
<li>A collection of operator classes (e.g., select, join, insert, delete, etc.) that process tuples;</li>
<li>A buffer pool that caches active tuples and pages in memory and handles concurrency control and transactions (neither of which you need to worry about for this lab); and,</li>
<li>A catalog that stores information about available tables and their schemas.</li>
</ul>
<p>SimpleDB does not include many things that you may think of as being a part of a “database.” In particular, SimpleDB does not have:</p>
<ul>
<li>(In this lab), a SQL front end or parser that allows you to type queries directly into SimpleDB. Instead, queries are built up by chaining a set of operators together into a hand-built query plan (see <a target="_blank" rel="noopener" href="https://github.com/MIT-DB-Class/simple-db-hw-2021/blob/master/lab1.md#query_walkthrough">Section 2.7</a>). We will provide a simple parser for use in later labs.</li>
<li>Views.</li>
<li>Data types except integers and fixed length strings.</li>
<li>(In this lab) Query optimizer.</li>
<li>(In this lab) Indices.</li>
</ul>
<p>In the rest of this Section, we describe each of the main components of SimpleDB that you will need to implement in this lab. You should use the exercises in this discussion to guide your implementation. This document is by no means a complete specification for SimpleDB; you will need to make decisions about how to design and implement various parts of the system. Note that for Lab 1 you do not need to implement any operators (e.g., select, join, project) except sequential scan. You will add support for additional operators in future labs.</p>
</blockquote>
<p>在本实验中，SimpleDB包括：</p>
<ul>
<li>首先，SimpleDB包括表示字段(<code>Fields</code>)、元组(<code>Tuple</code>)、元组模式(<code>TupleDesc</code>)的类；</li>
<li>包括用于过滤特定数据的类；</li>
<li>处理元组的运算符类（选择、连接、插入、删除）的集合。</li>
<li>缓冲池。</li>
</ul>
<p>在本实验中，SimpleDB不包括：</p>
<ul>
<li>SQL前端或者解析器；</li>
<li>索引；</li>
<li>查询优化器。</li>
</ul>
<h1 id="Lab-1"><a href="#Lab-1" class="headerlink" title="Lab-1"></a>Lab-1</h1><p>Lab-1主要实现数据库的基本数据结构，以及对硬盘上存储数据的访问。</p>
<p>本章涉及到的结构图为：</p>
<p><img src="https://raw.githubusercontent.com/love-you-3000/picUpload/master/images/image-20230824200708619.png" alt="image-20230824200708619"></p>
<h2 id="exercise-1"><a href="#exercise-1" class="headerlink" title="exercise-1"></a>exercise-1</h2><p>实现 <code>Tuple</code>, <code>TupleDesc</code>这两个类来管理元组和元组的描述。</p>
<p><code>Tuple</code>是<code>SimpleDB</code>中非常基本的元素，可以理解成数据表中的一行数据，它是由一组<code>Field</code>对象组成，也就是说数据库中的每个数据都是一个实现了<code>Filed</code>接口的类的实例对象。</p>
<p><img src="https://raw.githubusercontent.com/love-you-3000/picUpload/master/images/image-20230722101401358.png" alt="image-20230722101401358"></p>
<p>每个<code>Tuple</code>都有一个<code>TupleDesc</code>属性，<code>TupleDesc</code>类描述了表的元信息，可以理解成一张表有哪些字段以及每个字段的类型。</p>
<p><img src="https://raw.githubusercontent.com/love-you-3000/picUpload/master/images/image-20230717133922670.png" alt="image-20230717133922670"></p>
<p>这张图描述了<code>TupleDesc</code>的内容，<code>fieldName</code>和<code>fieldTyte</code>是字段的名字和类型，这两个属性被封装到一个<code>TDItem</code>类中，因此<code>TupleDesc</code>本质就是<code>TDItem</code>的集合。</p>
<p>首先实现<code>TupleDesc</code>.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> simpledb.storage;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> simpledb.common.Type;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * TupleDesc describes the schema of a tuple.</span></span><br><span class="line"><span class="comment"> * 一个tuple就是表中一行数据，TupleDesc就是表中每列字段的描述</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * TupleDesc describes the schema of a tuple.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TupleDesc</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;TDItem&gt; items;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> An iterator which iterates over all the field TDItems</span></span><br><span class="line"><span class="comment">     * that are included in this TupleDesc</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Iterator&lt;TDItem&gt; <span class="title function_">iterator</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> items.iterator();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a new TupleDesc with typeAr.length fields with fields of the</span></span><br><span class="line"><span class="comment">     * specified types, with associated named fields.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> typeAr  array specifying the number of and types of fields in this</span></span><br><span class="line"><span class="comment">     *                TupleDesc. It must contain at least one entry.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fieldAr array specifying the names of the fields. Note that names may</span></span><br><span class="line"><span class="comment">     *                be null.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TupleDesc</span><span class="params">(Type[] typeAr, String[] fieldAr)</span> &#123;</span><br><span class="line">        <span class="comment">//typeAr是字段类型数组,fieldAr是字段名数组</span></span><br><span class="line">        items = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(typeAr.length);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; typeAr.length; i++) &#123;</span><br><span class="line">            <span class="type">TDItem</span> <span class="variable">tdItem</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TDItem</span>(typeAr[i], fieldAr[i]);</span><br><span class="line">            items.add(tdItem);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constructor. Create a new tuple desc with typeAr.length fields with</span></span><br><span class="line"><span class="comment">     * fields of the specified types, with anonymous (unnamed) fields.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> typeAr array specifying the number of and types of fields in this</span></span><br><span class="line"><span class="comment">     *               TupleDesc. It must contain at least one entry.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TupleDesc</span><span class="params">(Type[] typeAr)</span> &#123;</span><br><span class="line">        <span class="comment">// 匿名字段</span></span><br><span class="line">        items = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(typeAr.length);</span><br><span class="line">        <span class="keyword">for</span> (Type type : typeAr) &#123;</span><br><span class="line">            <span class="type">TDItem</span> <span class="variable">item</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TDItem</span>(type, <span class="literal">null</span>);</span><br><span class="line">            items.add(item);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TupleDesc</span><span class="params">(List&lt;TDItem&gt; items)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.items = items;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the number of fields in this TupleDesc</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">numFields</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> items.size();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Gets the (possibly null) field name of the ith field of this TupleDesc.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> i index of the field name to return. It must be a valid index.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the name of the ith field</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NoSuchElementException if i is not a valid field reference.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getFieldName</span><span class="params">(<span class="type">int</span> i)</span> <span class="keyword">throws</span> NoSuchElementException &#123;</span><br><span class="line">        <span class="keyword">if</span> (i &lt; <span class="number">0</span> || i &gt;= items.size()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchElementException</span>(<span class="string">&quot;position &quot;</span> + i + <span class="string">&quot; is not a valid index&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> items.get(i).fieldName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Gets the type of the ith field of this TupleDesc.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> i The index of the field to get the type of. It must be a valid</span></span><br><span class="line"><span class="comment">     *          index.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the type of the ith field</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NoSuchElementException if i is not a valid field reference.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Type <span class="title function_">getFieldType</span><span class="params">(<span class="type">int</span> i)</span> <span class="keyword">throws</span> NoSuchElementException &#123;</span><br><span class="line">        <span class="keyword">if</span> (i &lt; <span class="number">0</span> || i &gt;= items.size()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchElementException</span>(<span class="string">&quot;position &quot;</span> + i + <span class="string">&quot; is not a valid index&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> items.get(i).fieldType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Find the index of the field with a given name.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name name of the field.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the index of the field that is first to have the given name.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NoSuchElementException if no field with a matching name is found.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">fieldNameToIndex</span><span class="params">(String name)</span> <span class="keyword">throws</span> NoSuchElementException &#123;</span><br><span class="line">        <span class="keyword">if</span> (name == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchElementException</span>(<span class="string">&quot;fieldName &quot;</span> + name + <span class="string">&quot; is not founded&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; items.size(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (name.equals(items.get(i).fieldName)) &#123;</span><br><span class="line">                <span class="keyword">return</span> i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchElementException</span>(<span class="string">&quot;fieldName &quot;</span> + name + <span class="string">&quot; is not founded&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> The size (in bytes) of tuples corresponding to this TupleDesc.</span></span><br><span class="line"><span class="comment">     * Note that tuples from a given TupleDesc are of a fixed size.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getSize</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 返回一行数据占的总字节数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">bytes</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (TDItem item : items) &#123;</span><br><span class="line">            bytes += item.fieldType.getLen();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Merge two TupleDescs into one, with td1.numFields + td2.numFields fields,</span></span><br><span class="line"><span class="comment">     * with the first td1.numFields coming from td1 and the remaining from td2.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> td1 The TupleDesc with the first fields of the new TupleDesc</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> td2 The TupleDesc with the last fields of the TupleDesc</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the new TupleDesc</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> TupleDesc <span class="title function_">merge</span><span class="params">(TupleDesc td1, TupleDesc td2)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> Set&lt;TDItem&gt; items = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(td1.items.size() + td2.items.size());</span><br><span class="line">        items.addAll(td1.getItems());</span><br><span class="line">        items.addAll(td2.getItems());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TupleDesc</span>(<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(items));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;TDItem&gt; <span class="title function_">getItems</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> items;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Compares the specified object with this TupleDesc for equality. Two</span></span><br><span class="line"><span class="comment">     * TupleDescs are considered equal if they have the same number of items</span></span><br><span class="line"><span class="comment">     * and if the i-th type in this TupleDesc is equal to the i-th type in o</span></span><br><span class="line"><span class="comment">     * for every i.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> o the Object to be compared for equality with this TupleDesc.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true if the object is equal to this TupleDesc.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.getClass().isInstance(o)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">TupleDesc</span> <span class="variable">desc</span> <span class="operator">=</span> (TupleDesc) o;</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> <span class="built_in">this</span>.items.size();</span><br><span class="line">        List&lt;TDItem&gt; tdItems = desc.getItems();</span><br><span class="line">        <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> tdItems.size();</span><br><span class="line">        <span class="keyword">if</span> (len != size) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">            <span class="type">TDItem</span> <span class="variable">item</span> <span class="operator">=</span> <span class="built_in">this</span>.items.get(i);</span><br><span class="line">            <span class="type">TDItem</span> <span class="variable">tdItem</span> <span class="operator">=</span> tdItems.get(i);</span><br><span class="line">            <span class="keyword">if</span> (!item.fieldType.equals(tdItem.fieldType)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// If you want to use TupleDesc as keys for HashMap, implement this so</span></span><br><span class="line">        <span class="comment">// that equal objects have equals hashCode() results</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>(<span class="string">&quot;unimplemented&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns a String describing this descriptor. It should be of the form</span></span><br><span class="line"><span class="comment">     * &quot;fieldType[0](fieldName[0]), ..., fieldType[M](fieldName[M])&quot;, although</span></span><br><span class="line"><span class="comment">     * the exact format does not matter.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> String describing this descriptor.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; items.size(); i++) &#123;</span><br><span class="line">            <span class="type">TDItem</span> <span class="variable">item</span> <span class="operator">=</span> items.get(i);</span><br><span class="line">            builder.append(item.fieldType).append(<span class="string">&quot;(&quot;</span>).append(item.fieldName).append(<span class="string">&quot;)&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (i != items.size() - <span class="number">1</span>) &#123;</span><br><span class="line">                builder.append(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> builder.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A help class to facilitate organizing the information of each field</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">TDItem</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * The type of the field</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> Type fieldType;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * The name of the field</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> String fieldName;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">TDItem</span><span class="params">(Type t, String n)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.fieldName = n;</span><br><span class="line">            <span class="built_in">this</span>.fieldType = t;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> fieldName + <span class="string">&quot;(&quot;</span> + fieldType + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后实现<code>Tuple</code>。</p>
<p>每一个<code>Tuple</code>对象都是表中的一行数据，每个数据都是一个实现了<code>Field</code>接口的对象，因此，Tuple中包含一个Field的集合，其次，每个<code>Tuple</code>有一个<code>TupleDesc</code>对象以及<code>RecordId</code>，<code>RecordId</code>用来记录当前<code>tuple</code>位于文件的第几页以及第几个槽。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> simpledb.storage;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Tuple maintains information about the contents of a tuple. Tuples have a</span></span><br><span class="line"><span class="comment"> * specified schema specified by a TupleDesc object and contain Field objects</span></span><br><span class="line"><span class="comment"> * with the data for each field.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Tuple</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> TupleDesc td; <span class="comment">// 元组描述</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;Field&gt; fields; <span class="comment">// Field集合，相当于这一行数据的集合</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RecordId recordId;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>; <span class="comment">// 序列化ID</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a new tuple with the specified schema (type).</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> td the schema of this tuple. It must be a valid TupleDesc</span></span><br><span class="line"><span class="comment">     *           instance with at least one field.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Tuple</span><span class="params">(TupleDesc td)</span> &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="built_in">this</span>.td = td;</span><br><span class="line">        fields = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; td.numFields(); i++) &#123;</span><br><span class="line">            fields.add(<span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> The TupleDesc representing the schema of this tuple.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> TupleDesc <span class="title function_">getTupleDesc</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.td;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> The RecordId representing the location of this tuple on disk. May</span></span><br><span class="line"><span class="comment">     * be null.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> RecordId <span class="title function_">getRecordId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.recordId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Set the RecordId information for this tuple.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rid the new RecordId for this tuple.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRecordId</span><span class="params">(RecordId rid)</span> &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="built_in">this</span>.recordId = rid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Change the value of the ith field of this tuple.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> i index of the field to change. It must be a valid index.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> f new value for the field.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setField</span><span class="params">(<span class="type">int</span> i, Field f)</span> &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        fields.set(i, f);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> i field index to return. Must be a valid index.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the value of the ith field, or null if it has not been set.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Field <span class="title function_">getField</span><span class="params">(<span class="type">int</span> i)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fields.get(i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the contents of this Tuple as a string. Note that to pass the</span></span><br><span class="line"><span class="comment">     * system tests, the format needs to be as follows:</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * column1\tcolumn2\tcolumn3\t...\tcolumnN</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * where \t is any whitespace (except a newline)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.fields.size(); i++) &#123;</span><br><span class="line">            s.append(fields.get(i).toString());</span><br><span class="line">            <span class="keyword">if</span> (i &lt; fields.size() - <span class="number">1</span>)</span><br><span class="line">                s.append(<span class="string">&quot;\t&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> s.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> An iterator which iterates over all the fields of this tuple</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Iterator&lt;Field&gt; <span class="title function_">fields</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="keyword">return</span> fields.iterator();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * reset the TupleDesc of this tuple (only affecting the TupleDesc)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">resetTupleDesc</span><span class="params">(TupleDesc td)</span> &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="built_in">this</span>.td = td;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="exercise-2"><a href="#exercise-2" class="headerlink" title="exercise-2"></a>exercise-2</h2><p>需要实现<code>Catalog</code>类。</p>
<ul>
<li><code>Catalog</code>：目录。数据库包含很多张表，Catalog管理着数据库中的所有表。由于数据库<code>Database</code>为单例设计，而调用数据库的Catalog需要调用<code>Database.getCatalog()</code>方法，因此Catalog也可以视作单例。</li>
<li><code>DbFile</code>：为数据库磁盘文件的接口。数据库中每张表对应着一个<code>DbFile</code>，<code>DbFile</code>储存着表中的所有信息。</li>
</ul>
<p>在<code>Catalog</code>中，似乎并没有关于 <em>表</em> 的直接表示。因此，可以创建一个<code>Table</code>内部类作为辅助，该内部类包含<code>DBFile</code>,<code>name</code>,<code>pkeyField</code>三个属性，分别代表存储Table的文件，表名和主键名。</p>
<p><img src="https://raw.githubusercontent.com/love-you-3000/picUpload/master/images/image-20230722101127978.png" alt="image-20230722101127978"></p>
<p>因此<code>Catalog</code>的实现需要维护一个哈希表，键是传入<code>DBFile</code>的<code>id</code>属性，值就是具体的table，同时，为了解决表名如果重复的问题，我这里的解决方案是如果表名重复就覆盖之前的表，因此还有维护一个表名为键，表id为值的哈希表，这样在插入新表之前，要根据表名判断是否重名。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> simpledb.common;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> simpledb.storage.DbFile;</span><br><span class="line"><span class="keyword">import</span> simpledb.storage.HeapFile;</span><br><span class="line"><span class="keyword">import</span> simpledb.storage.TupleDesc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The Catalog keeps track of all available tables in the database and their</span></span><br><span class="line"><span class="comment"> * associated schemas.</span></span><br><span class="line"><span class="comment"> * For now, this is a stub catalog that must be populated with tables by a</span></span><br><span class="line"><span class="comment"> * user program before it can be used -- eventually, this should be converted</span></span><br><span class="line"><span class="comment"> * to a catalog that reads a catalog table from disk.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Threadsafe</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Catalog</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Table</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> DbFile dbFile; <span class="comment">// 存放表数据的文件</span></span><br><span class="line">        <span class="keyword">private</span> String name; <span class="comment">// 表名</span></span><br><span class="line">        <span class="keyword">private</span> String pkeyField; <span class="comment">// 主键</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Table</span><span class="params">(DbFile dbFile, String name, String pkeyField)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.dbFile = dbFile;</span><br><span class="line">            <span class="built_in">this</span>.pkeyField = pkeyField;</span><br><span class="line">            <span class="built_in">this</span>.name = name;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;Integer, Table&gt; tables;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;String, Integer&gt; TableNameMapId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constructor.</span></span><br><span class="line"><span class="comment">     * Creates a new, empty catalog.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Catalog</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        tables = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        TableNameMapId = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Add a new table to the catalog.</span></span><br><span class="line"><span class="comment">     * This table&#x27;s contents are stored in the specified DbFile.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> file      the contents of the table to add;  file.getId() is the identfier of</span></span><br><span class="line"><span class="comment">     *                  this file/tupledesc param for the calls getTupleDesc and getFile</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name      the name of the table -- may be an empty string.  May not be null.  If a name</span></span><br><span class="line"><span class="comment">     *                  conflict exists, use the last table to be added as the table for a given name.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pkeyField the name of the primary key field</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addTable</span><span class="params">(DbFile file, String name, String pkeyField)</span> &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="type">Table</span> <span class="variable">table</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Table</span>(file, name, pkeyField);</span><br><span class="line">        tables.put(file.getId(), table);</span><br><span class="line">        <span class="keyword">if</span> (TableNameMapId.containsKey((name)))</span><br><span class="line">            <span class="comment">// 覆盖重复表名数据</span></span><br><span class="line">            tables.remove(TableNameMapId.get(name));</span><br><span class="line">        TableNameMapId.put(name, file.getId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addTable</span><span class="params">(DbFile file, String name)</span> &#123;</span><br><span class="line">        addTable(file, name, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Add a new table to the catalog.</span></span><br><span class="line"><span class="comment">     * This table has tuples formatted using the specified TupleDesc and its</span></span><br><span class="line"><span class="comment">     * contents are stored in the specified DbFile.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> file the contents of the table to add;  file.getId() is the identfier of</span></span><br><span class="line"><span class="comment">     *             this file/tupledesc param for the calls getTupleDesc and getFile</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addTable</span><span class="params">(DbFile file)</span> &#123;</span><br><span class="line">        addTable(file, (UUID.randomUUID()).toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return the id of the table with a specified name,</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NoSuchElementException if the table doesn&#x27;t exist</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getTableId</span><span class="params">(String name)</span> <span class="keyword">throws</span> NoSuchElementException &#123;</span><br><span class="line">        <span class="keyword">for</span> (Integer integer : tables.keySet()) &#123;</span><br><span class="line">            <span class="type">Table</span> <span class="variable">table</span> <span class="operator">=</span> tables.get(integer);</span><br><span class="line">            <span class="keyword">if</span> (table.name.equals(name)) <span class="keyword">return</span> table.dbFile.getId();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchElementException</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the tuple descriptor (schema) of the specified table</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tableid The id of the table, as specified by the DbFile.getId()</span></span><br><span class="line"><span class="comment">     *                function passed to addTable</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NoSuchElementException if the table doesn&#x27;t exist</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> TupleDesc <span class="title function_">getTupleDesc</span><span class="params">(<span class="type">int</span> tableid)</span> <span class="keyword">throws</span> NoSuchElementException &#123;</span><br><span class="line">        <span class="type">Table</span> <span class="variable">table</span> <span class="operator">=</span> tables.get(tableid);</span><br><span class="line">        <span class="keyword">if</span> (table != <span class="literal">null</span>) <span class="keyword">return</span> table.dbFile.getTupleDesc();</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchElementException</span>();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the DbFile that can be used to read the contents of the</span></span><br><span class="line"><span class="comment">     * specified table.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tableid The id of the table, as specified by the DbFile.getId()</span></span><br><span class="line"><span class="comment">     *                function passed to addTable</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> DbFile <span class="title function_">getDatabaseFile</span><span class="params">(<span class="type">int</span> tableid)</span> <span class="keyword">throws</span> NoSuchElementException &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="type">Table</span> <span class="variable">table</span> <span class="operator">=</span> tables.get(tableid);</span><br><span class="line">        <span class="keyword">if</span> (table != <span class="literal">null</span>) <span class="keyword">return</span> table.dbFile;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchElementException</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPrimaryKey</span><span class="params">(<span class="type">int</span> tableid)</span> &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="keyword">return</span> tables.get(tableid).pkeyField;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Iterator&lt;Integer&gt; <span class="title function_">tableIdIterator</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="keyword">return</span> tables.keySet().iterator();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTableName</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="keyword">return</span> tables.get(id).name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Delete all tables from the catalog</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">clear</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        tables.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Reads the schema from a file and creates the appropriate tables in the database.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> catalogFile</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">loadSchema</span><span class="params">(String catalogFile)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">line</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">baseFolder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="keyword">new</span> <span class="title class_">File</span>(catalogFile).getAbsolutePath()).getParent();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">FileReader</span>(catalogFile));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> ((line = br.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">//assume line is of the format name (field type, field type, ...)</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> line.substring(<span class="number">0</span>, line.indexOf(<span class="string">&quot;(&quot;</span>)).trim();</span><br><span class="line">                <span class="comment">//System.out.println(&quot;TABLE NAME: &quot; + name);</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">fields</span> <span class="operator">=</span> line.substring(line.indexOf(<span class="string">&quot;(&quot;</span>) + <span class="number">1</span>, line.indexOf(<span class="string">&quot;)&quot;</span>)).trim();</span><br><span class="line">                String[] els = fields.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">                ArrayList&lt;String&gt; names = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">                ArrayList&lt;Type&gt; types = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">                <span class="type">String</span> <span class="variable">primaryKey</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">                <span class="keyword">for</span> (String e : els) &#123;</span><br><span class="line">                    String[] els2 = e.trim().split(<span class="string">&quot; &quot;</span>);</span><br><span class="line">                    names.add(els2[<span class="number">0</span>].trim());</span><br><span class="line">                    <span class="keyword">if</span> (els2[<span class="number">1</span>].trim().equalsIgnoreCase(<span class="string">&quot;int&quot;</span>))</span><br><span class="line">                        types.add(Type.INT_TYPE);</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (els2[<span class="number">1</span>].trim().equalsIgnoreCase(<span class="string">&quot;string&quot;</span>))</span><br><span class="line">                        types.add(Type.STRING_TYPE);</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;Unknown type &quot;</span> + els2[<span class="number">1</span>]);</span><br><span class="line">                        System.exit(<span class="number">0</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (els2.length == <span class="number">3</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (els2[<span class="number">2</span>].trim().equals(<span class="string">&quot;pk&quot;</span>))</span><br><span class="line">                            primaryKey = els2[<span class="number">0</span>].trim();</span><br><span class="line">                        <span class="keyword">else</span> &#123;</span><br><span class="line">                            System.out.println(<span class="string">&quot;Unknown annotation &quot;</span> + els2[<span class="number">2</span>]);</span><br><span class="line">                            System.exit(<span class="number">0</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                Type[] typeAr = types.toArray(<span class="keyword">new</span> <span class="title class_">Type</span>[<span class="number">0</span>]);</span><br><span class="line">                String[] namesAr = names.toArray(<span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">0</span>]);</span><br><span class="line">                <span class="type">TupleDesc</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TupleDesc</span>(typeAr, namesAr);</span><br><span class="line">                <span class="type">HeapFile</span> <span class="variable">tabHf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HeapFile</span>(<span class="keyword">new</span> <span class="title class_">File</span>(baseFolder + <span class="string">&quot;/&quot;</span> + name + <span class="string">&quot;.dat&quot;</span>), t);</span><br><span class="line">                addTable(tabHf, name, primaryKey);</span><br><span class="line">                System.out.println(<span class="string">&quot;Added table : &quot;</span> + name + <span class="string">&quot; with schema &quot;</span> + t);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            System.exit(<span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IndexOutOfBoundsException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Invalid catalog entry : &quot;</span> + line);</span><br><span class="line">            System.exit(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="exercise-3"><a href="#exercise-3" class="headerlink" title="exercise-3"></a>exercise-3</h2><p>需要实现<code>BufferPool</code>类中的<code>getPage()</code>方法。</p>
<p>首先了解一些概念</p>
<ul>
<li><code>BufferPool</code>：缓存池。与<code>Catalog</code> 一样，也是数据库中的单例对象，由<code>Database.getBufferPool()</code>获取。</li>
<li><code>HeapFile</code>：<code>DbFile</code>的一种无序实现。在lab1中，所有<code>DbFile</code>均由<code>HeapFile</code>实现。</li>
<li><code>Page</code>：表中的某一”页”。这是一个让我在第一次接触时感到比较困惑的概念。可以简单地理解为<code>DbFile</code>被分割为许多<code>Page</code>。</li>
<li><code>HeapPage</code>：<code>Page</code>的一种实现，与<code>HeapFile</code>搭配使用。<ul>
<li><code>PageId</code>：<code>Page</code>的id，储存了<code>Page</code>所在<code>DbFile</code>对应的<code>tableid</code>(哈希生成，这个值就是之前<code>CataLog</code>的键)，以及<code>Page</code>在<code>DbFile</code>中的序号<code>pageNum</code>(从0顺序生成)。</li>
</ul>
</li>
</ul>
<p>在读取数据时，我们需要调用<code>BufferPool</code>中的<code>getPage()</code>方法，而不能直接从磁盘读取。当调用<code>getPage</code>时，我们先尝试在<code>BufferPool</code>中找到对应<code>Page</code>，若未找到，则从在磁盘中找到对应<code>HeapFile</code>的对应<code>Page</code>，并将此<code>Page</code>加入<code>BufferPool</code>中。<code>BufferPool</code>管理的是<code>Page</code>而不是直接管理整个<code>HeapFile</code>，也许<code>HeapFile</code>文件过大是原因之一。而<code>Page</code>将<code>HeapFile</code>分割，提高了空间的利用。</p>
<p>每个Page容纳的字节数由<code>BufferPool</code>指定。<code>BufferPool</code>在管理的<code>Page</code>数量达到上限时，需要实现对储存<code>Page</code>的置换策略，lab-1暂时不需要实现置换。	</p>
<p><code>Page</code>与<code>PageId</code>绑定，所以<code>BufferPoo</code>l使用HashMap储存<code>Page</code>，键为<code>PageId</code>，值为Page。<strong>一定要记得重写实现了<code>PageId</code>接口的类的<code>hashcode</code>方法。</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> simpledb.storage;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> simpledb.common.Catalog;</span><br><span class="line"><span class="keyword">import</span> simpledb.common.Database;</span><br><span class="line"><span class="keyword">import</span> simpledb.common.DbException;</span><br><span class="line"><span class="keyword">import</span> simpledb.common.Permissions;</span><br><span class="line"><span class="keyword">import</span> simpledb.transaction.TransactionAbortedException;</span><br><span class="line"><span class="keyword">import</span> simpledb.transaction.TransactionId;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * BufferPool manages the reading and writing of pages into memory from</span></span><br><span class="line"><span class="comment"> * disk. Access methods call into it to retrieve pages, and it fetches</span></span><br><span class="line"><span class="comment"> * pages from the appropriate location.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * The BufferPool is also responsible for locking;  when a transaction fetches</span></span><br><span class="line"><span class="comment"> * a page, BufferPool checks that the transaction has the appropriate</span></span><br><span class="line"><span class="comment"> * locks to read/write the page.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Threadsafe</span>, all fields are final</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BufferPool</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Bytes per page, including header.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEFAULT_PAGE_SIZE</span> <span class="operator">=</span> <span class="number">4096</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">pageSize</span> <span class="operator">=</span> DEFAULT_PAGE_SIZE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;Integer, Page&gt; pageStores;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Default number of pages passed to the constructor. This is used by</span></span><br><span class="line"><span class="comment">     * other classes. BufferPool should use the numPages argument to the</span></span><br><span class="line"><span class="comment">     * constructor instead.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEFAULT_PAGES</span> <span class="operator">=</span> <span class="number">50</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> numPages;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a BufferPool that caches up to numPages pages.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> numPages maximum number of pages in this buffer pool.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BufferPool</span><span class="params">(<span class="type">int</span> numPages)</span> &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="built_in">this</span>.numPages = numPages;</span><br><span class="line">        <span class="built_in">this</span>.pageStores = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getPageSize</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> pageSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// THIS FUNCTION SHOULD ONLY BE USED FOR TESTING!!</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setPageSize</span><span class="params">(<span class="type">int</span> pageSize)</span> &#123;</span><br><span class="line">        BufferPool.pageSize = pageSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// THIS FUNCTION SHOULD ONLY BE USED FOR TESTING!!</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">resetPageSize</span><span class="params">()</span> &#123;</span><br><span class="line">        BufferPool.pageSize = DEFAULT_PAGE_SIZE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Retrieve the specified page with the associated permissions.</span></span><br><span class="line"><span class="comment">     * Will acquire a lock and may block if that lock is held by another</span></span><br><span class="line"><span class="comment">     * transaction.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * The retrieved page should be looked up in the buffer pool.  If it</span></span><br><span class="line"><span class="comment">     * is present, it should be returned.  If it is not present, it should</span></span><br><span class="line"><span class="comment">     * be added to the buffer pool and returned.  If there is insufficient</span></span><br><span class="line"><span class="comment">     * space in the buffer pool, a page should be evicted and the new page</span></span><br><span class="line"><span class="comment">     * should be added in its place.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tid  the ID of the transaction requesting the page</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pid  the ID of the requested page</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> perm the requested permissions on the page</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Page <span class="title function_">getPage</span><span class="params">(TransactionId tid, PageId pid, Permissions perm)</span></span><br><span class="line">            <span class="keyword">throws</span> TransactionAbortedException, DbException &#123;</span><br><span class="line">        <span class="keyword">if</span> (!pageStores.containsKey(pid.hashCode())) &#123;</span><br><span class="line">            <span class="type">DbFile</span> <span class="variable">file</span> <span class="operator">=</span> Database.getCatalog().getDatabaseFile(pid.getTableId());</span><br><span class="line">            <span class="type">Page</span> <span class="variable">page</span> <span class="operator">=</span> file.readPage(pid);</span><br><span class="line">            pageStores.put(pid.hashCode(), page);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> pageStores.get(pid.hashCode());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Releases the lock on a page.</span></span><br><span class="line"><span class="comment">     * Calling this is very risky, and may result in wrong behavior. Think hard</span></span><br><span class="line"><span class="comment">     * about who needs to call this and why, and why they can run the risk of</span></span><br><span class="line"><span class="comment">     * calling it.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tid the ID of the transaction requesting the unlock</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pid the ID of the page to unlock</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unsafeReleasePage</span><span class="params">(TransactionId tid, PageId pid)</span> &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="comment">// not necessary for lab1|lab2</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Release all locks associated with a given transaction.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tid the ID of the transaction requesting the unlock</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transactionComplete</span><span class="params">(TransactionId tid)</span> &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="comment">// not necessary for lab1|lab2</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return true if the specified transaction has a lock on the specified page</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">holdsLock</span><span class="params">(TransactionId tid, PageId p)</span> &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="comment">// not necessary for lab1|lab2</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Commit or abort a given transaction; release all locks associated to</span></span><br><span class="line"><span class="comment">     * the transaction.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tid    the ID of the transaction requesting the unlock</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> commit a flag indicating whether we should commit or abort</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transactionComplete</span><span class="params">(TransactionId tid, <span class="type">boolean</span> commit)</span> &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="comment">// not necessary for lab1|lab2</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Add a tuple to the specified table on behalf of transaction tid.  Will</span></span><br><span class="line"><span class="comment">     * acquire a write lock on the page the tuple is added to and any other</span></span><br><span class="line"><span class="comment">     * pages that are updated (Lock acquisition is not needed for lab2).</span></span><br><span class="line"><span class="comment">     * May block if the lock(s) cannot be acquired.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * Marks any pages that were dirtied by the operation as dirty by calling</span></span><br><span class="line"><span class="comment">     * their markDirty bit, and adds versions of any pages that have</span></span><br><span class="line"><span class="comment">     * been dirtied to the cache (replacing any existing versions of those pages) so</span></span><br><span class="line"><span class="comment">     * that future requests see up-to-date pages.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tid     the transaction adding the tuple</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tableId the table to add the tuple to</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t       the tuple to add</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertTuple</span><span class="params">(TransactionId tid, <span class="type">int</span> tableId, Tuple t)</span></span><br><span class="line">            <span class="keyword">throws</span> DbException, IOException, TransactionAbortedException &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="comment">// not necessary for lab1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Remove the specified tuple from the buffer pool.</span></span><br><span class="line"><span class="comment">     * Will acquire a write lock on the page the tuple is removed from and any</span></span><br><span class="line"><span class="comment">     * other pages that are updated. May block if the lock(s) cannot be acquired.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * Marks any pages that were dirtied by the operation as dirty by calling</span></span><br><span class="line"><span class="comment">     * their markDirty bit, and adds versions of any pages that have</span></span><br><span class="line"><span class="comment">     * been dirtied to the cache (replacing any existing versions of those pages) so</span></span><br><span class="line"><span class="comment">     * that future requests see up-to-date pages.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tid the transaction deleting the tuple.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t   the tuple to delete</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteTuple</span><span class="params">(TransactionId tid, Tuple t)</span></span><br><span class="line">            <span class="keyword">throws</span> DbException, IOException, TransactionAbortedException &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="comment">// not necessary for lab1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Flush all dirty pages to disk.</span></span><br><span class="line"><span class="comment">     * NB: Be careful using this routine -- it writes dirty data to disk so will</span></span><br><span class="line"><span class="comment">     * break simpledb if running in NO STEAL mode.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">flushAllPages</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="comment">// not necessary for lab1</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Remove the specific page id from the buffer pool.</span></span><br><span class="line"><span class="comment">     * Needed by the recovery manager to ensure that the</span></span><br><span class="line"><span class="comment">     * buffer pool doesn&#x27;t keep a rolled back page in its</span></span><br><span class="line"><span class="comment">     * cache.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * Also used by B+ tree files to ensure that deleted pages</span></span><br><span class="line"><span class="comment">     * are removed from the cache so they can be reused safely</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">discardPage</span><span class="params">(PageId pid)</span> &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="comment">// not necessary for lab1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Flushes a certain page to disk</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pid an ID indicating the page to flush</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">flushPage</span><span class="params">(PageId pid)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="comment">// not necessary for lab1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Write all pages of the specified transaction to disk.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">flushPages</span><span class="params">(TransactionId tid)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="comment">// not necessary for lab1|lab2</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Discards a page from the buffer pool.</span></span><br><span class="line"><span class="comment">     * Flushes the page to disk to ensure dirty pages are updated on disk.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">evictPage</span><span class="params">()</span> <span class="keyword">throws</span> DbException &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="comment">// not necessary for lab1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="exercise-4"><a href="#exercise-4" class="headerlink" title="exercise-4"></a>exercise-4</h2><p>实现<code>HeapPageId</code>、<code>RecordId</code>和<code>HeapPage</code>三个类。</p>
<p>这一部分是最有难度的，需要理解<code>Page</code>在磁盘上的存储结构。</p>
<p>HeapPage的在磁盘上的结构为</p>
<p><img src="https://raw.githubusercontent.com/love-you-3000/picUpload/master/images/image-20230722101009928.png" alt="image-20230722101009928"></p>
<p><code>HeapPageId</code>实现了<code>PageId</code>接口，其中主要2个属性，<code>tableId</code>和<code>pageNo</code>，<code>tableId</code>是关联的<code>page</code>的<code>id</code>，不在赘述了。</p>
<p><img src="https://raw.githubusercontent.com/love-you-3000/picUpload/master/images/image-20230722101117263.png" alt="image-20230722101117263"></p>
<p><code>RecordId</code>是指向表中特定页特定<code>Tuple</code>的类，他有两个属性，分别是<code>*PageId*</code>以及<code>tupleno</code>,代表<code>PageId</code>中的第<code>tupleno</code>个<code>tuple</code>。</p>
<p>重点是<code>HeapPage</code>，<code>HeapFile</code>是具体存储一个表的磁盘文件，该文件由多个<code>Page</code>的排列组成，每个<code>Page</code>由固定数量的字节组成，由<code>BufferPool.DEFAULT_PAGE_SIZE</code>定义，HeapFile 中的每个页面都排列为一组槽，每个槽可以容纳一个元组，每个元组具有相同的大小，<code>Page</code>中除了存放槽，每个页面还有一个<code>bitmap</code>类型的header，用来对应每个槽的状态，如果值为1，说明槽正常使用，如果为0，说明被删除或者其他情况，总之不能继续使用。</p>
<p>因此，可以计算一下每一页能存放的槽的数量。</p>
<p><code>_tuples per page_ = floor((_page size_ * 8) / (_tuple size_ * 8 + 1))</code></p>
<p><code>_page size_</code>是页面的总大小（字节为单位），<code>_tuple size_</code>是每个元组的字节大小，因为header中还要为每个槽存一位，因此一个槽占用的空间可以计算成<code>(_tuple size_ * 8 + 1)</code>。</p>
<p>然后我们去计算header需要多少个字节去存，通过向上取整取得结果。</p>
<p><code>headerBytes = ceiling(tupsPerPage/8)</code></p>
<p>通过向上取整，最后一个字节的高位可能与文件中实际存在的槽不对应，因为槽的数量可能不是 8 的倍数。</p>
<p>这部分理解后我们就可以实现<code>HeapPage</code>类了。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> simpledb.storage;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> simpledb.common.Database;</span><br><span class="line"><span class="keyword">import</span> simpledb.common.DbException;</span><br><span class="line"><span class="keyword">import</span> simpledb.common.Debug;</span><br><span class="line"><span class="keyword">import</span> simpledb.common.Catalog;</span><br><span class="line"><span class="keyword">import</span> simpledb.transaction.TransactionId;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Each instance of HeapPage stores data for one page of HeapFiles and</span></span><br><span class="line"><span class="comment"> * implements the Page interface that is used by BufferPool.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> HeapFile</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> BufferPool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HeapPage</span> <span class="keyword">implements</span> <span class="title class_">Page</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> HeapPageId pid;</span><br><span class="line">    <span class="keyword">final</span> TupleDesc td; <span class="comment">// todo 疑惑，一个table是一个DBFile，DBFile中已经有了TupleDesc属性，为什么每一页还要有这个属性</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">byte</span>[] header; <span class="comment">// 头信息字节数组</span></span><br><span class="line">    <span class="keyword">final</span> Tuple[] tuples;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> numSlots;</span><br><span class="line">    <span class="type">byte</span>[] oldData;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Byte</span> <span class="variable">oldDataLock</span> <span class="operator">=</span> (<span class="type">byte</span>) <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a HeapPage from a set of bytes of data read from disk.</span></span><br><span class="line"><span class="comment">     * The format of a HeapPage is a set of header bytes indicating</span></span><br><span class="line"><span class="comment">     * the slots of the page that are in use, some number of tuple slots.</span></span><br><span class="line"><span class="comment">     * Specifically, the number of tuples is equal to: &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * floor((BufferPool.getPageSize()*8) / (tuple size * 8 + 1))</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; where tuple size is the size of tuples in this</span></span><br><span class="line"><span class="comment">     * database table, which can be determined via &#123;<span class="doctag">@link</span> Catalog#getTupleDesc&#125;.</span></span><br><span class="line"><span class="comment">     * The number of 8-bit header words is equal to:</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * ceiling(no. tuple slots / 8)</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> Database#getCatalog</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> Catalog#getTupleDesc</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> BufferPool#getPageSize()</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HeapPage</span><span class="params">(HeapPageId id, <span class="type">byte</span>[] data)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="built_in">this</span>.pid = id; <span class="comment">// 页id</span></span><br><span class="line">        <span class="built_in">this</span>.td = Database.getCatalog().getTupleDesc(id.getTableId()); <span class="comment">// 表的元信息</span></span><br><span class="line">        <span class="built_in">this</span>.numSlots = getNumTuples(); <span class="comment">// 有多少个槽，每个槽存一个tuple</span></span><br><span class="line">        <span class="type">DataInputStream</span> <span class="variable">dis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(data)); <span class="comment">// 读取原始文件</span></span><br><span class="line">        <span class="comment">// allocate and read the header slots of this page</span></span><br><span class="line">        header = <span class="keyword">new</span> <span class="title class_">byte</span>[getHeaderSize()]; <span class="comment">// 头信息初始化，一个bitmap</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; header.length; i++)</span><br><span class="line">            header[i] = dis.readByte();</span><br><span class="line">        tuples = <span class="keyword">new</span> <span class="title class_">Tuple</span>[numSlots];</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// allocate and read the actual records of this page</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; tuples.length; i++)</span><br><span class="line">                tuples[i] = readNextTuple(dis, i);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchElementException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        dis.close();</span><br><span class="line">        setBeforeImage();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Retrieve the number of tuples on this page.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the number of tuples on this page</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">getNumTuples</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="comment">// 返回一个heapfile中tuple的个数</span></span><br><span class="line">        <span class="keyword">return</span> (<span class="type">int</span>) Math.floor((BufferPool.getPageSize() * <span class="number">8.0</span>) / (<span class="built_in">this</span>.td.getSize() * <span class="number">8</span> + <span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Computes the number of bytes in the header of a page in a HeapFile with each tuple occupying tupleSize bytes</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the number of bytes in the header of a page in a HeapFile with each tuple occupying tupleSize bytes</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">getHeaderSize</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="comment">// header占用的字节数</span></span><br><span class="line">        <span class="keyword">return</span> (<span class="type">int</span>) Math.ceil(getNumTuples() * <span class="number">1.0</span> / <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return a view of this page before it was modified</span></span><br><span class="line"><span class="comment">     * -- used by recovery</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> HeapPage <span class="title function_">getBeforeImage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">byte</span>[] oldDataRef = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">synchronized</span> (oldDataLock) &#123;</span><br><span class="line">                oldDataRef = oldData;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HeapPage</span>(pid, oldDataRef);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="comment">//should never happen -- we parsed it OK before!</span></span><br><span class="line">            System.exit(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBeforeImage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (oldDataLock) &#123;</span><br><span class="line">            oldData = getPageData().clone();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the PageId associated with this page.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> HeapPageId <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.pid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Suck up tuples from the source file.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Tuple <span class="title function_">readNextTuple</span><span class="params">(DataInputStream dis, <span class="type">int</span> slotId)</span> <span class="keyword">throws</span> NoSuchElementException &#123;</span><br><span class="line">        <span class="comment">// if associated bit is not set, read forward to the next tuple, and</span></span><br><span class="line">        <span class="comment">// return null.</span></span><br><span class="line">        <span class="keyword">if</span> (!isSlotUsed(slotId)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; td.getSize(); i++) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    dis.readByte();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchElementException</span>(<span class="string">&quot;error reading empty tuple&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// read fields in the tuple</span></span><br><span class="line">        <span class="type">Tuple</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Tuple</span>(td);</span><br><span class="line">        <span class="type">RecordId</span> <span class="variable">rid</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RecordId</span>(pid, slotId);</span><br><span class="line">        t.setRecordId(rid);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; td.numFields(); j++) &#123;</span><br><span class="line">                <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> td.getFieldType(j).parse(dis);</span><br><span class="line">                t.setField(j, f);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (java.text.ParseException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchElementException</span>(<span class="string">&quot;parsing error!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> t;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Generates a byte array representing the contents of this page.</span></span><br><span class="line"><span class="comment">     * Used to serialize this page to disk.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * The invariant here is that it should be possible to pass the byte</span></span><br><span class="line"><span class="comment">     * array generated by getPageData to the HeapPage constructor and</span></span><br><span class="line"><span class="comment">     * have it produce an identical HeapPage object.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> A byte array correspond to the bytes of this page.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #HeapPage</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] getPageData() &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> BufferPool.getPageSize();</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>(len);</span><br><span class="line">        <span class="type">DataOutputStream</span> <span class="variable">dos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataOutputStream</span>(baos);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// create the header of the page</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">byte</span> b : header) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                dos.writeByte(b);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="comment">// this really shouldn&#x27;t happen</span></span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// create the tuples</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; tuples.length; i++) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// empty slot</span></span><br><span class="line">            <span class="keyword">if</span> (!isSlotUsed(i)) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; td.getSize(); j++) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        dos.writeByte(<span class="number">0</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// non-empty slot</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; td.numFields(); j++) &#123;</span><br><span class="line">                <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> tuples[i].getField(j);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    f.serialize(dos);</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// padding</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">zerolen</span> <span class="operator">=</span> BufferPool.getPageSize() - (header.length + td.getSize() * tuples.length); <span class="comment">//- numSlots * td.getSize();</span></span><br><span class="line">        <span class="type">byte</span>[] zeroes = <span class="keyword">new</span> <span class="title class_">byte</span>[zerolen];</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            dos.write(zeroes, <span class="number">0</span>, zerolen);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            dos.flush();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> baos.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Static method to generate a byte array corresponding to an empty</span></span><br><span class="line"><span class="comment">     * HeapPage.</span></span><br><span class="line"><span class="comment">     * Used to add new, empty pages to the file. Passing the results of</span></span><br><span class="line"><span class="comment">     * this method to the HeapPage constructor will create a HeapPage with</span></span><br><span class="line"><span class="comment">     * no valid tuples in it.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> The returned ByteArray.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] createEmptyPageData() &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> BufferPool.getPageSize();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[len]; <span class="comment">//all 0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Delete the specified tuple from the page; the corresponding header bit should be updated to reflect</span></span><br><span class="line"><span class="comment">     * that it is no longer stored on any page.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t The tuple to delete</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> DbException if this tuple is not on this page, or tuple slot is</span></span><br><span class="line"><span class="comment">     *                     already empty.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteTuple</span><span class="params">(Tuple t)</span> <span class="keyword">throws</span> DbException &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="comment">// not necessary for lab1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Adds the specified tuple to the page;  the tuple should be updated to reflect</span></span><br><span class="line"><span class="comment">     * that it is now stored on this page.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t The tuple to add.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> DbException if the page is full (no empty slots) or tupledesc</span></span><br><span class="line"><span class="comment">     *                     is mismatch.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertTuple</span><span class="params">(Tuple t)</span> <span class="keyword">throws</span> DbException &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="comment">// not necessary for lab1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Marks this page as dirty/not dirty and record that transaction</span></span><br><span class="line"><span class="comment">     * that did the dirtying</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">markDirty</span><span class="params">(<span class="type">boolean</span> dirty, TransactionId tid)</span> &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="comment">// not necessary for lab1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the tid of the transaction that last dirtied this page, or null if the page is not dirty</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> TransactionId <span class="title function_">isDirty</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="comment">// Not necessary for lab1</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the number of empty slots on this page.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getNumEmptySlots</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="comment">// 从头文件的bitmap中统计0的个数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numSlots; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!isSlotUsed(i)) c++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns true if associated slot on this page is filled.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isSlotUsed</span><span class="params">(<span class="type">int</span> i)</span> &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">ind</span> <span class="operator">=</span> i / <span class="number">8</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">remainder</span> <span class="operator">=</span> i % <span class="number">8</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">bit</span> <span class="operator">=</span> (header[ind] &gt;&gt; remainder) &amp; <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> bit == <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Abstraction to fill or clear a slot on this page.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">markSlotUsed</span><span class="params">(<span class="type">int</span> i, <span class="type">boolean</span> value)</span> &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="comment">// not necessary for lab1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> an iterator over all tuples on this page (calling remove on this iterator throws an UnsupportedOperationException)</span></span><br><span class="line"><span class="comment">     * (note that this iterator shouldn&#x27;t return tuples in empty slots!)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Iterator&lt;Tuple&gt; <span class="title function_">iterator</span><span class="params">()</span> &#123;</span><br><span class="line">        ArrayList&lt;Tuple&gt; t = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numSlots; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isSlotUsed(i)) t.add(tuples[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> t.iterator();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重点2个方法，一个是怎么判断指定第n个slot是否能正常使用。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isSlotUsed</span><span class="params">(<span class="type">int</span> i)</span> &#123;</span><br><span class="line">    <span class="comment">// some code goes here</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">ind</span> <span class="operator">=</span> i / <span class="number">8</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">remainder</span> <span class="operator">=</span> i % <span class="number">8</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">bit</span> <span class="operator">=</span> (header[ind] &gt;&gt; remainder) &amp; <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> bit == <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还有介绍迭代器，只返回能正常使用的slot的迭代器。</p>
<h2 id="exercise-5"><a href="#exercise-5" class="headerlink" title="exercise-5"></a>exercise-5</h2><p>实现<code>HeapFile</code>类。</p>
<p><img src="https://raw.githubusercontent.com/love-you-3000/picUpload/master/images/image-20230722101104007.png" alt="image-20230722101104007"></p>
<p><code>*HeapFile*</code>对应着一张表，由多个<code>Page</code>组成，可以通过方法<code>public Page readPage(PageId pid)</code>来获取文件中指定某一页的信息。</p>
<p>因为需要对文件特定位置进行读取，所以需要使用<code>*RandomAccessFile*</code>来读取，该类支持对文件随机访问。</p>
<p>此外，<code>HeapFile</code>中的iterator实现是一个难点。由于一个<code>HeapFile</code>包含多个<code>HeapPage</code>，所以在实现<code>hasNext()</code>方法时，需要遍历完所有的<code>HeapPage</code>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> simpledb.storage;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> simpledb.common.Database;</span><br><span class="line"><span class="keyword">import</span> simpledb.common.DbException;</span><br><span class="line"><span class="keyword">import</span> simpledb.common.Permissions;</span><br><span class="line"><span class="keyword">import</span> simpledb.transaction.TransactionAbortedException;</span><br><span class="line"><span class="keyword">import</span> simpledb.transaction.TransactionId;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.RandomAccessFile;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.NoSuchElementException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * HeapFile is an implementation of a DbFile that stores a collection of tuples</span></span><br><span class="line"><span class="comment"> * in no particular order. Tuples are stored on pages, each of which is a fixed</span></span><br><span class="line"><span class="comment"> * size, and the file is simply a collection of those pages. HeapFile works</span></span><br><span class="line"><span class="comment"> * closely with HeapPage. The format of HeapPages is described in the HeapPage</span></span><br><span class="line"><span class="comment"> * constructor.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Sam Madden</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> HeapPage#HeapPage</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HeapFile</span> <span class="keyword">implements</span> <span class="title class_">DbFile</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> File file;</span><br><span class="line">    <span class="keyword">private</span> TupleDesc td;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constructs a heap file backed by the specified file.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> file the file that stores the on-disk backing store for this heap</span></span><br><span class="line"><span class="comment">     *          file.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HeapFile</span><span class="params">(File file, TupleDesc td)</span> &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="built_in">this</span>.file = file;</span><br><span class="line">        <span class="built_in">this</span>.td = td;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the File backing this HeapFile on disk.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the File backing this HeapFile on disk.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> File <span class="title function_">getFile</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="keyword">return</span> file;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns an ID uniquely identifying this HeapFile. Implementation note:</span></span><br><span class="line"><span class="comment">     * you will need to generate this tableid somewhere to ensure that each</span></span><br><span class="line"><span class="comment">     * HeapFile has a &quot;unique id,&quot; and that you always return the same value for</span></span><br><span class="line"><span class="comment">     * a particular HeapFile. We suggest hashing the absolute file name of the</span></span><br><span class="line"><span class="comment">     * file underlying the heapfile, i.e. f.getAbsoluteFile().hashCode().</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> an ID uniquely identifying this HeapFile.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="keyword">return</span> file.getAbsoluteFile().hashCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the TupleDesc of the table stored in this DbFile.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> TupleDesc of this DbFile.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> TupleDesc <span class="title function_">getTupleDesc</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.td;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// see DbFile.java for javadocs</span></span><br><span class="line">    <span class="keyword">public</span> Page <span class="title function_">readPage</span><span class="params">(PageId pid)</span> &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">tableId</span> <span class="operator">=</span> pid.getTableId();</span><br><span class="line">        <span class="type">int</span> <span class="variable">pgNo</span> <span class="operator">=</span> pid.getPageNumber();</span><br><span class="line"></span><br><span class="line">        <span class="type">RandomAccessFile</span> <span class="variable">f</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            f = <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(file, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> ((<span class="type">long</span>) (pgNo + <span class="number">1</span>) * BufferPool.getPageSize() &gt; f.length()) &#123;</span><br><span class="line">                f.close();</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(String.format(<span class="string">&quot;table %d page %d is invalid&quot;</span>, tableId, pgNo));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[BufferPool.getPageSize()];</span><br><span class="line">            f.seek((<span class="type">long</span>) pgNo * BufferPool.getPageSize());</span><br><span class="line">            <span class="comment">// big end</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">read</span> <span class="operator">=</span> f.read(bytes, <span class="number">0</span>, BufferPool.getPageSize());</span><br><span class="line">            <span class="keyword">if</span> (read != BufferPool.getPageSize()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(String.format(<span class="string">&quot;table %d page %d read %d bytes&quot;</span>, tableId, pgNo, read));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">HeapPageId</span> <span class="variable">id</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HeapPageId</span>(pid.getTableId(), pid.getPageNumber());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HeapPage</span>(id, bytes);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                f.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(String.format(<span class="string">&quot;table %d page %d is invalid&quot;</span>, tableId, pgNo));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// see DbFile.java for javadocs</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writePage</span><span class="params">(Page page)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="comment">// not necessary for lab1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the number of pages in this HeapFile.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">numPages</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="keyword">return</span> (<span class="type">int</span>)Math.floor(file.length()*<span class="number">1.0</span>/BufferPool.getPageSize());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// see DbFile.java for javadocs</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Page&gt; <span class="title function_">insertTuple</span><span class="params">(TransactionId tid, Tuple t)</span></span><br><span class="line">            <span class="keyword">throws</span> DbException, IOException, TransactionAbortedException &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// not necessary for lab1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// see DbFile.java for javadocs</span></span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;Page&gt; <span class="title function_">deleteTuple</span><span class="params">(TransactionId tid, Tuple t)</span> <span class="keyword">throws</span> DbException,</span><br><span class="line">            TransactionAbortedException &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// not necessary for lab1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// see DbFile.java for javadocs</span></span><br><span class="line">    <span class="keyword">public</span> DbFileIterator <span class="title function_">iterator</span><span class="params">(TransactionId tid)</span> &#123;</span><br><span class="line">        <span class="comment">// some code goes here</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HeapFileIterator</span>(<span class="built_in">this</span>,tid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">HeapFileIterator</span> <span class="keyword">implements</span> <span class="title class_">DbFileIterator</span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> HeapFile heapFile;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> TransactionId tid;</span><br><span class="line">        <span class="keyword">private</span> Iterator&lt;Tuple&gt; it;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> whichPage;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">HeapFileIterator</span><span class="params">(HeapFile file,TransactionId tid)</span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.heapFile = file;</span><br><span class="line">            <span class="built_in">this</span>.tid = tid;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">open</span><span class="params">()</span> <span class="keyword">throws</span> DbException, TransactionAbortedException &#123;</span><br><span class="line">            <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">            whichPage = <span class="number">0</span>;</span><br><span class="line">            it = getPageTuples(whichPage);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Iterator&lt;Tuple&gt; <span class="title function_">getPageTuples</span><span class="params">(<span class="type">int</span> pageNumber)</span> <span class="keyword">throws</span> TransactionAbortedException, DbException&#123;</span><br><span class="line">            <span class="keyword">if</span>(pageNumber &gt;= <span class="number">0</span> &amp;&amp; pageNumber &lt; heapFile.numPages())&#123;</span><br><span class="line">                <span class="type">HeapPageId</span> <span class="variable">pid</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HeapPageId</span>(heapFile.getId(),pageNumber);</span><br><span class="line">                <span class="type">HeapPage</span> <span class="variable">page</span> <span class="operator">=</span> (HeapPage) Database.getBufferPool().getPage(tid, pid, Permissions.READ_ONLY);</span><br><span class="line">                <span class="keyword">return</span> page.iterator();</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DbException</span>(String.format(<span class="string">&quot;heapfile %d does not contain page %d!&quot;</span>, pageNumber,heapFile.getId()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasNext</span><span class="params">()</span> <span class="keyword">throws</span> DbException, TransactionAbortedException &#123;</span><br><span class="line">            <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">            <span class="keyword">if</span>(it == <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(!it.hasNext())&#123;</span><br><span class="line">                <span class="keyword">if</span>(whichPage &lt; (heapFile.numPages()-<span class="number">1</span>))&#123;</span><br><span class="line">                    whichPage++;</span><br><span class="line">                    it = getPageTuples(whichPage);</span><br><span class="line">                    <span class="keyword">return</span> it.hasNext();</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Tuple <span class="title function_">next</span><span class="params">()</span> <span class="keyword">throws</span> DbException, TransactionAbortedException, NoSuchElementException &#123;</span><br><span class="line">            <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">            <span class="keyword">if</span>(it == <span class="literal">null</span> || !it.hasNext())&#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchElementException</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> it.next();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">rewind</span><span class="params">()</span> <span class="keyword">throws</span> DbException, TransactionAbortedException &#123;</span><br><span class="line">            <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">            close();</span><br><span class="line">            open();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">            it = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="exercise-6"><a href="#exercise-6" class="headerlink" title="exercise-6"></a>exercise-6</h2><p>实现<code>SeqScan</code>类。</p>
<p>对[exercise 5](<a target="_blank" rel="noopener" href="https://www.zhihu.com/search?q=exercise">https://www.zhihu.com/search?q=exercise</a> 5&amp;search_source&#x3D;Entity&amp;hybrid_search_source&#x3D;Entity&amp;hybrid_search_extra&#x3D;{“sourceType”%3A”article”%2C”sourceId”%3A”402325847”})中实现的iterator做简单封装即可。</p>
<p>注意，在<code>getTupleDesc()</code>方法中，不能直接返回原tupleDesc，需要为tupleDesc的fieldName加上表的别名前缀，即alias.fieldName。</p>
<p>实现<code>SeqScan</code>类后，可以通过<code>ScanTest</code>系统测试。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> simpledb.execution;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> simpledb.common.Catalog;</span><br><span class="line"><span class="keyword">import</span> simpledb.common.Database;</span><br><span class="line"><span class="keyword">import</span> simpledb.common.DbException;</span><br><span class="line"><span class="keyword">import</span> simpledb.storage.DbFile;</span><br><span class="line"><span class="keyword">import</span> simpledb.storage.DbFileIterator;</span><br><span class="line"><span class="keyword">import</span> simpledb.storage.Tuple;</span><br><span class="line"><span class="keyword">import</span> simpledb.storage.TupleDesc;</span><br><span class="line"><span class="keyword">import</span> simpledb.transaction.TransactionAbortedException;</span><br><span class="line"><span class="keyword">import</span> simpledb.transaction.TransactionId;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.NoSuchElementException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * SeqScan is an implementation of a sequential scan access method that reads</span></span><br><span class="line"><span class="comment"> * each tuple of a table in no particular order (e.g., as they are laid out on</span></span><br><span class="line"><span class="comment"> * disk).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeqScan</span> <span class="keyword">implements</span> <span class="title class_">OpIterator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Catalog catalog;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TransactionId tid;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> tableId;</span><br><span class="line">    <span class="keyword">private</span> TupleDesc tupleDesc;</span><br><span class="line">    <span class="keyword">private</span> String tableName;</span><br><span class="line">    <span class="keyword">private</span> String tableAlias;</span><br><span class="line">    <span class="keyword">private</span> DbFileIterator iterator;</span><br><span class="line">    <span class="keyword">private</span> DbFile file;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a sequential scan over the specified table as a part of the</span></span><br><span class="line"><span class="comment">     * specified transaction.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tid        The transaction this scan is running as a part of.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tableid    the table to scan.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tableAlias the alias of this table (needed by the parser); the returned</span></span><br><span class="line"><span class="comment">     *                   tupleDesc should have fields with name tableAlias.fieldName</span></span><br><span class="line"><span class="comment">     *                   (note: this class is not responsible for handling a case where</span></span><br><span class="line"><span class="comment">     *                   tableAlias or fieldName are null. It shouldn&#x27;t crash if they</span></span><br><span class="line"><span class="comment">     *                   are, but the resulting name can be null.fieldName,</span></span><br><span class="line"><span class="comment">     *                   tableAlias.null, or null.null).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SeqScan</span><span class="params">(TransactionId tid, <span class="type">int</span> tableid, String tableAlias)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.catalog = Database.getCatalog();</span><br><span class="line">        <span class="built_in">this</span>.tid = tid;</span><br><span class="line">        <span class="built_in">this</span>.tableId = tableid;</span><br><span class="line">        <span class="built_in">this</span>.tupleDesc = changeTupleDesc(catalog.getTupleDesc(tableid), tableAlias);</span><br><span class="line">        <span class="built_in">this</span>.tableName = catalog.getTableName(tableid);</span><br><span class="line">        <span class="built_in">this</span>.tableAlias = tableAlias;</span><br><span class="line">        <span class="built_in">this</span>.file = catalog.getDatabaseFile(tableid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * select * from testTable AS tt where tt.a=1 and tt.b=2 ;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> TupleDesc <span class="title function_">changeTupleDesc</span><span class="params">(TupleDesc desc, String alias)</span> &#123;</span><br><span class="line">        List&lt;TupleDesc.TDItem&gt; items = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        List&lt;TupleDesc.TDItem&gt; tdItems = desc.getItems();</span><br><span class="line">        <span class="keyword">for</span> (TupleDesc.TDItem tdItem : tdItems) &#123;</span><br><span class="line">            TupleDesc.<span class="type">TDItem</span> <span class="variable">item</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TupleDesc</span>.TDItem(tdItem.fieldType, alias + <span class="string">&quot;.&quot;</span> + tdItem.fieldName);</span><br><span class="line">            items.add(item);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TupleDesc</span>(items);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> return the table name of the table the operator scans. This should</span></span><br><span class="line"><span class="comment">     * be the actual name of the table in the catalog of the database</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTableName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> tableName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Return the alias of the table this operator scans.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getAlias</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> tableAlias;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Reset the tableid, and tableAlias of this operator.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tableid    the table to scan.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tableAlias the alias of this table (needed by the parser); the returned</span></span><br><span class="line"><span class="comment">     *                   tupleDesc should have fields with name tableAlias.fieldName</span></span><br><span class="line"><span class="comment">     *                   (note: this class is not responsible for handling a case where</span></span><br><span class="line"><span class="comment">     *                   tableAlias or fieldName are null. It shouldn&#x27;t crash if they</span></span><br><span class="line"><span class="comment">     *                   are, but the resulting name can be null.fieldName,</span></span><br><span class="line"><span class="comment">     *                   tableAlias.null, or null.null).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reset</span><span class="params">(<span class="type">int</span> tableid, String tableAlias)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.tableId = tableid;</span><br><span class="line">        <span class="built_in">this</span>.tableAlias = tableAlias;</span><br><span class="line">        <span class="built_in">this</span>.tupleDesc = changeTupleDesc(catalog.getTupleDesc(tableid), tableAlias);</span><br><span class="line">        <span class="built_in">this</span>.tableName = catalog.getTableName(tableid);</span><br><span class="line">        <span class="built_in">this</span>.file = catalog.getDatabaseFile(tableid);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            open();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (DbException | TransactionAbortedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SeqScan</span><span class="params">(TransactionId tid, <span class="type">int</span> tableId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(tid, tableId, Database.getCatalog().getTableName(tableId));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">open</span><span class="params">()</span> <span class="keyword">throws</span> DbException, TransactionAbortedException &#123;</span><br><span class="line">        <span class="built_in">this</span>.iterator = <span class="built_in">this</span>.file.iterator(<span class="built_in">this</span>.tid);</span><br><span class="line">        iterator.open();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the TupleDesc with field names from the underlying HeapFile,</span></span><br><span class="line"><span class="comment">     * prefixed with the tableAlias string from the constructor. This prefix</span></span><br><span class="line"><span class="comment">     * becomes useful when joining tables containing a field(s) with the same</span></span><br><span class="line"><span class="comment">     * name.  The alias and name should be separated with a &quot;.&quot; character</span></span><br><span class="line"><span class="comment">     * (e.g., &quot;alias.fieldName&quot;).</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the TupleDesc with field names from the underlying HeapFile,</span></span><br><span class="line"><span class="comment">     * prefixed with the tableAlias string from the constructor.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> TupleDesc <span class="title function_">getTupleDesc</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.tupleDesc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasNext</span><span class="params">()</span> <span class="keyword">throws</span> TransactionAbortedException, DbException &#123;</span><br><span class="line">        <span class="keyword">if</span> (iterator == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> iterator.hasNext();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Tuple <span class="title function_">next</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchElementException,</span><br><span class="line">            TransactionAbortedException, DbException &#123;</span><br><span class="line">        <span class="keyword">if</span> (iterator == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchElementException</span>(<span class="string">&quot;No next tuple&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Tuple</span> <span class="variable">tuple</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">        <span class="keyword">if</span> (tuple == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchElementException</span>(<span class="string">&quot;No next tuple&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> tuple;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> &#123;</span><br><span class="line">        iterator = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">rewind</span><span class="params">()</span> <span class="keyword">throws</span> DbException, NoSuchElementException,</span><br><span class="line">            TransactionAbortedException &#123;</span><br><span class="line">        iterator.rewind();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>Lab-1断断续续做了3天，主要是对宏观的结构把握不太准确导致在lab-5上耽误了很多的时间，好在坚持先来了，希望之后的lab能够顺利写完。</p>
</article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>MIT6.830-Lab-1</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="https://jiangblog.top/2023/07/15/MIT6-830-lab1/">https://jiangblog.top/2023/07/15/MIT6-830-lab1/</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>作者</h><div class="post-copyright-cc-info"><h>Jiang</h></div></div><div class="post-copyright-c"><h>发布于</h><div class="post-copyright-cc-info"><h>2023-07-15</h></div></div><div class="post-copyright-u"><h>更新于</h><div class="post-copyright-cc-info"><h>2023-07-15</h></div></div><div class="post-copyright-c"><h>许可协议</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/MIT6-830/">MIT6.830</a></div><div class="post_share"><div class="social-share" data-image="/img/lab1.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/07/19/MIT6-830-lab2/" title="MIT6.830-Lab-2"><img class="cover" src="/img/lab2.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">MIT6.830-Lab-2</div></div></a></div><div class="next-post pull-right"><a href="/2023/07/13/%E4%B8%AD%E9%97%B4%E4%BB%B6-redis-dataStruct/" title="Redis"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Redis</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/07/19/MIT6-830-lab2/" title="MIT6.830-Lab-2"><img class="cover" src="/img/lab2.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-07-19</div><div class="title">MIT6.830-Lab-2</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Jiang</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">24</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">14</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/love-you-3000"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/love-you-3000" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:18834198033@163.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">欢迎来到我的博客^_^,本站评论采用Giscus, 发表评论请先登录github</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Lab-1"><span class="toc-number">2.</span> <span class="toc-text">Lab-1</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#exercise-1"><span class="toc-number">2.1.</span> <span class="toc-text">exercise-1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exercise-2"><span class="toc-number">2.2.</span> <span class="toc-text">exercise-2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exercise-3"><span class="toc-number">2.3.</span> <span class="toc-text">exercise-3</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exercise-4"><span class="toc-number">2.4.</span> <span class="toc-text">exercise-4</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exercise-5"><span class="toc-number">2.5.</span> <span class="toc-text">exercise-5</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exercise-6"><span class="toc-number">2.6.</span> <span class="toc-text">exercise-6</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">3.</span> <span class="toc-text">总结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/09/08/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80-os/" title="无题">无题</a><time datetime="2023-09-08T06:54:45.472Z" title="发表于 2023-09-08 14:54:45">2023-09-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/08/30/leetcode-baseAlg/" title="基础算法总结"><img src="/img/hot.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="基础算法总结"/></a><div class="content"><a class="title" href="/2023/08/30/leetcode-baseAlg/" title="基础算法总结">基础算法总结</a><time datetime="2023-08-30T01:06:11.000Z" title="发表于 2023-08-30 09:06:11">2023-08-30</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/08/28/%E6%BA%90%E7%A0%81-ConcurrentHashMap/" title="无题">无题</a><time datetime="2023-08-28T13:30:56.850Z" title="发表于 2023-08-28 21:30:56">2023-08-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/07/25/spring-autowire/" title="自动装配">自动装配</a><time datetime="2023-07-25T14:22:05.000Z" title="发表于 2023-07-25 22:22:05">2023-07-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/07/24/MIT6-830-lab4/" title="lab4">lab4</a><time datetime="2023-07-24T01:15:54.000Z" title="发表于 2023-07-24 09:15:54">2023-07-24</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Jiang</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>function getGiscusTheme (theme) {
  return theme === 'dark' ? 'dark' : 'light'
}

function loadGiscus () {
  const config = Object.assign({
    src: 'https://giscus.app/client.js',
    'data-repo': 'love-you-3000/giscus',
    'data-repo-id': 'R_kgDOJzFPYQ',
    'data-category-id': 'DIC_kwDOJzFPYc4CXas5',
    'data-mapping': 'pathname',
    'data-theme': getGiscusTheme(document.documentElement.getAttribute('data-theme')),
    'data-reactions-enabled': '1',
    crossorigin: 'anonymous',
    async: true
  },null)

  let ele = document.createElement('script')
  for (let key in config) {
    ele.setAttribute(key, config[key])
  }
  document.getElementById('giscus-wrap').insertAdjacentElement('afterbegin',ele)
}

function changeGiscusTheme (theme) {
  function sendMessage(message) {
    const iframe = document.querySelector('iframe.giscus-frame')
    if (!iframe) return
    iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app')
  }

  sendMessage({
    setConfig: {
      theme: getGiscusTheme(theme)
    }
  });
}

btf.addModeChange('giscus', changeGiscusTheme)

if ('Giscus' === 'Giscus' || !true) {
  if (true) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
  else loadGiscus()
} else {
  function loadOtherComment () {
    loadGiscus()
  }
}</script></div><script async src="/js/title.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="false" data-text="I,LOVE,YOU" data-fontsize="15px" data-random="false" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_clock_anzhiyu_injector_config(){
    var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
    var item_html = '<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>';
    console.log('已挂载butterfly_clock_anzhiyu')
    if(parent_div_git) {
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = '/';
  var qweather_key = 'b2dc59ff50b24673b677f4e13ad22962';
  var gaud_map_key = 'e2b04289e870b005374ee030148d64fd&s=rsv3';
  var baidu_ak_key = 'undefined';
  var flag = 0;
  var clock_rectangle = '113.34532,23.15624';
  var clock_default_rectangle_enable = 'false';

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_clock_anzhiyu_injector_config();
  }
  else if (epage === cpage){
    butterfly_clock_anzhiyu_injector_config();
  }
  </script><script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script><script data-pjax src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.js"></script><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="2023/06/22/welcome/" alt=""><img width="48" height="48" src="/img/welcome.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-06-22</span><a class="blog-slider__title" href="2023/06/22/welcome/" alt="">欢迎光临我的小破站</a><div class="blog-slider__text">再怎么看我也不知道怎么描述它的啦！</div><a class="blog-slider__button" href="2023/06/22/welcome/" alt="">详情   </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('已挂载butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><!-- hexo injector body_end end --></body></html>